{# inventory/templates/inventory/step3_payment.html #}
{% extends 'core/layout.html' %}
{% load static %}

{% block title %}Complete Sales Booking Deposit - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-3xl">
    <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Complete Your Deposit</h2>

        {% include 'inventory/_sales_booking_summary_include.html' %}
        
        {% if payment_already_succeeded %}
        <div id="payment-success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-6" role="alert">
            <span class="block sm:inline">Your payment has already been successfully processed. Redirecting you to confirmation...</span>
        </div>
        <script>
            window.location.href = "{% url 'inventory:step4_confirmation' %}?payment_intent_id={{ temp_booking.stripe_payment_intent_id }}";
        </script>
        {% endif %}

        <form id="payment-form" class="space-y-4">
            {% csrf_token %}
            <div>
                <label for="card-element" class="block text-sm font-medium text-gray-700 mb-2">
                    Credit or debit card
                </label>
                <div id="card-element" class="StripeElement">
                </div>
                <div id="card-errors" role="alert" class="text-red-600 text-sm mt-2"></div>
            </div>

            <div id="payment-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                <span class="block sm:inline"></span>
            </div>

            <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                <a href="{% url 'inventory:step2_booking_details_and_appointment' %}" class="text-sm font-medium text-gray-600 hover:text-indigo-500 transition duration-150 ease-in-out">
                    &larr; Previous Step
                </a>
                <button
                    id="submit-button"
                    class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-150 ease-in-out"
                >
                    Pay {{ amount|floatformat:2 }} {{ currency }} Deposit
                </button>
            </div>
        </form>
    </div>

    <div class="max-w-3xl mx-auto mt-8">
        {% with title=faq_title %}
            {% include 'inventory/_sales_FAQ_include.html' %}
        {% endwith %}
    </div>

</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripePublishableKey = "{{ stripe_publishable_key }}";
    const clientSecret = "{{ client_secret }}";

    const stripe = Stripe(stripePublishableKey);
    const elements = stripe.elements();

    const card = elements.create('card', {
        style: {
            base: {
                iconColor: '#6B7280',
                color: '#374151',
                fontWeight: '500',
                fontFamily: 'Inter, sans-serif',
                fontSize: '16px',
                '::placeholder': {
                    color: '#9CA3AF',
                },
            },
            invalid: {
                iconColor: '#EF4444',
                color: '#EF4444',
            },
        }
    });

    card.mount('#card-element');

    card.on('change', function(event) {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
            displayError.textContent = event.error.message;
        } else {
            displayError.textContent = '';
        }
    });

    function showMessage(messageText, isError = true) {
        const messageContainer = document.getElementById('payment-message');
        if (messageContainer) {
            const messageSpan = messageContainer.querySelector('span');
            messageSpan.textContent = messageText;
            messageContainer.classList.remove('hidden');
            if (isError) {
                messageContainer.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                messageContainer.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                messageContainer.classList.remove('bg-red-100', 'border-red-400', 'text-green-700');
                messageContainer.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            }
        } else {
            console.warn("Payment message container not found. Message: ", messageText);
        }
    }

    const form = document.getElementById('payment-form');
    form.addEventListener('submit', async function(event) {
        event.preventDefault();

        const submitButton = document.getElementById('submit-button');
        submitButton.disabled = true;
        submitButton.textContent = 'Processing...';
        document.getElementById('payment-message').classList.add('hidden');

        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
            payment_method: {
                card: card,
            }
        });

        if (error) {
            const errorDisplay = document.getElementById('card-errors');
            errorDisplay.textContent = error.message;
            showMessage(error.message, true);
            submitButton.disabled = false;
            submitButton.textContent = `Pay {{ amount|floatformat:2 }} {{ currency }} Deposit`;
        } else {
            if (paymentIntent.status === 'succeeded') {
                const redirectUrl = "{% url 'inventory:step4_confirmation' %}" + "?payment_intent_id=" + paymentIntent.id;
                window.location.href = redirectUrl;

            } else {
                const errorDisplay = document.getElementById('card-errors');
                errorDisplay.textContent = 'Payment status: ' + paymentIntent.status + '. Please try again or contact support.';
                showMessage('Payment status: ' + paymentIntent.status + '. Please try again or contact support.', true);
                submitButton.disabled = false;
                submitButton.textContent = `Pay {{ amount|floatformat:2 }} {{ currency }} Deposit`;
            }
        }
    });
</script>
{% endblock content %}
