{# inventory/templates/inventory/step2_booking_details.html #}
{% extends 'core/layout.html' %}
{% load static %}

{% block title %}Booking Details & Appointment{% endblock %}

{% block extra_head %}
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr Theme (optional, but good for consistent styling) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        Booking Details & Appointment
    </h1>

    <div class="bg-white shadow-lg rounded-lg p-6 md:p-8 max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
            Motorcycle: {{ temp_booking.motorcycle.year }} {{ temp_booking.motorcycle.brand }} {{ temp_booking.motorcycle.model }}
        </h2>
        {% if temp_booking.motorcycle.image %}
            <div class="flex justify-center mb-6">
                <img src="{{ temp_booking.motorcycle.image.url }}" alt="{{ temp_booking.motorcycle.title }}" class="w-full md:w-3/4 lg:w-1/2 h-48 object-cover rounded-md">
            </div>
        {% else %}
            <div class="w-full h-48 bg-gray-200 flex items-center justify-center rounded-md mb-4 text-gray-500">
                No Image Available
            </div>
        {% endif %}

        <form method="post" class="space-y-6">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline">{{ form.non_field_errors }}</span>
                </div>
            {% endif %}

            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Appointment Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {# Request Viewing Checkbox #}
                <div class="form-group md:col-span-2">
                    <div class="flex items-center">
                        {{ form.request_viewing }}
                        <label for="{{ form.request_viewing.id_for_label }}" class="ml-2 block text-sm font-medium text-gray-700">
                            {{ form.request_viewing.label }}
                        </label>
                    </div>
                    {% if form.request_viewing.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.request_viewing.help_text }}</p>
                    {% endif %}
                    {% for error in form.request_viewing.errors %}
                        <p class="text-red-600 text-sm italic">{{ error }}</p>
                    {% endfor %}
                </div>

                {# Appointment Date Field #}
                <div class="form-group">
                    <label for="{{ form.appointment_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        {{ form.appointment_date.label }}
                    </label>
                    {{ form.appointment_date }}
                    {% if form.appointment_date.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.appointment_date.help_text }}</p>
                    {% endif %}
                    {% for error in form.appointment_date.errors %}
                        <p class="text-red-600 text-sm italic">{{ error }}</p>
                    {% endfor %}
                </div>

                {# Appointment Time Field #}
                <div class="form-group">
                    <label for="{{ form.appointment_time.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        {{ form.appointment_time.label }}
                    </label>
                    {{ form.appointment_time }}
                    {% if form.appointment_time.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.appointment_time.help_text }}</p>
                    {% endif %}
                    {% for error in form.appointment_time.errors %}
                        <p class="text-red-600 text-sm italic">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4 border-b pb-2">Additional Information</h3>
            <div class="grid grid-cols-1 gap-4">
                {# Customer Notes Field #}
                <div class="form-group">
                    <label for="{{ form.customer_notes.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        {{ form.customer_notes.label }}
                    </label>
                    {{ form.customer_notes }}
                    {% if form.customer_notes.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.customer_notes.help_text }}</p>
                    {% endif %}
                    {% for error in form.customer_notes.errors %}
                        <p class="text-red-600 text-sm italic">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <a href="{% url 'inventory:step1_sales_profile' %}"
                   class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-md shadow-sm
                          hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Previous: Your Details
                </a>
                <button type="submit"
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md
                               hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {% if temp_booking.deposit_required_for_flow %}
                        Next: Payment
                    {% else %}
                        Submit Enquiry
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appointmentDateInput = document.getElementById('id_appointment_date');
            const appointmentTimeSelect = document.getElementById('id_appointment_time');
            const availableDates = '{{ available_dates|json_script:"available_dates_json" }}';
            const parsedAvailableDates = JSON.parse(document.getElementById('available_dates_json').textContent);

            // Initialize Flatpickr for the appointment date input
            flatpickr(appointmentDateInput, {
                dateFormat: "Y-m-d",
                minDate: "today",
                enable: [
                    function(date) {
                        const formattedDate = flatpickr.formatDate(date, "Y-m-d");
                        return parsedAvailableDates.includes(formattedDate);
                    }
                ],
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        fetchAvailableTimes(dateStr);
                    } else {
                        // Clear time options if date is cleared
                        appointmentTimeSelect.innerHTML = '<option value="">---------</option>';
                    }
                }
            });

            // Function to fetch available times via AJAX
            function fetchAvailableTimes(selectedDate) {
                const url = "{% url 'inventory:ajax_get_appointment_times' %}?date=" + selectedDate;
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        appointmentTimeSelect.innerHTML = '<option value="">---------</option>'; // Clear existing options
                        if (data.available_times && data.available_times.length > 0) {
                            data.available_times.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time.value;
                                option.textContent = time.text;
                                appointmentTimeSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "No times available for this date";
                            appointmentTimeSelect.appendChild(option);
                        }

                        // If there was a pre-selected time from temp_booking, try to select it
                        const initialTime = "{{ temp_booking.appointment_time|time:'H:i' }}";
                        if (initialTime && initialTime !== 'None') {
                            const matchingOption = Array.from(appointmentTimeSelect.options).find(option => option.value === initialTime);
                            if (matchingOption) {
                                appointmentTimeSelect.value = initialTime;
                            }
                        }

                    })
                    .catch(error => {
                        console.error('Error fetching available times:', error);
                        appointmentTimeSelect.innerHTML = '<option value="">Error loading times</option>';
                    });
            }

            // Initial call if a date is already pre-selected (e.g., on form reload with errors)
            if (appointmentDateInput.value) {
                fetchAvailableTimes(appointmentDateInput.value);
            }
        });
    </script>
{% endblock %}
