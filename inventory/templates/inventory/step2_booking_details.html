{# inventory/templates/inventory/step2_booking_details.html #}
{% extends 'core/layout.html' %}
{% load static %}

{% block title %}Booking Details & Appointment{% endblock %}

{% block extra_head %}
    <!-- Flatpickr CSS for Date -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/material_blue.css">
    <style>
        /* Custom radio button styling */
        .form-radio {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            display: inline-block;
            vertical-align: middle;
            background-color: #fff;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 50%;
            width: 16px; /* h-4 */
            height: 16px; /* w-4 */
            outline: none;
            cursor: pointer;
        }

        .form-radio:checked {
            background-color: #4f46e5; /* indigo-600 */
            border-color: #4f46e5; /* indigo-600 */
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3ccircle cx='8' cy='8' r='3'/%3e%3c/svg%3e");
        }

        .form-radio:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.5); /* focus:ring-indigo-500 with opacity */
        }
    </style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">
        Booking Details & Appointment
    </h1>

    <div class="bg-white shadow-lg rounded-lg p-6 md:p-8 max-w-2xl mx-auto">
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 text-center">
            Motorcycle: {{ temp_booking.motorcycle.year }} {{ temp_booking.motorcycle.brand }} {{ temp_booking.motorcycle.model }}
        </h2>
        {% if temp_booking.motorcycle.image %}
            <div class="flex justify-center mb-6">
                <img src="{{ temp_booking.motorcycle.image.url }}" alt="{{ temp_booking.motorcycle.title }}" class="w-full md:w-3/4 lg:w-1/2 h-48 object-cover rounded-md">
            </div>
        {% else %}
            <div class="w-full h-48 bg-gray-200 flex items-center justify-center rounded-md mb-4 text-gray-500">
                No Image Available
            </div>
        {% endif %}

        <form method="post" class="space-y-6">
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                    <strong class="font-bold">Error!</strong>
                    <span class="block sm:inline">{{ form.non_field_errors }}</span>
                </div>
            {% endif %}

            <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Appointment Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {# Request Viewing Radio Buttons #}
                <div class="form-group md:col-span-2">
                    {% if form.request_viewing.field.widget.input_type != 'hidden' %}
                        <label class="block text-sm font-medium text-gray-700">{{ form.request_viewing.label }}</label>
                        <div class="mt-2 flex space-x-4">
                            {% for radio in form.request_viewing %}
                                <div class="flex items-center">
                                    {{ radio.tag }}
                                    <label for="{{ radio.id_for_label }}" class="ml-2 block text-sm font-medium text-gray-700">
                                        {{ radio.choice_label }}
                                    </label>
                                </div>
                            {% endfor %}
                        </div>
                        {% if form.request_viewing.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.request_viewing.help_text }}</p>
                        {% endif %}
                        {% for error in form.request_viewing.errors %}
                            <p class="text-red-600 text-sm italic">{{ error }}</p>
                        {% endfor %}
                    {% else %}
                        {# If it's a hidden input, just render the hidden input tag directly #}
                        {{ form.request_viewing }}
                        {# Only show label and message if deposit is NOT required, or if viewing for enquiry is enabled #}
                        {% if not temp_booking.deposit_required_for_flow %}
                            <label class="block text-sm font-medium text-gray-700">{{ form.request_viewing.label }}</label>
                            <p class="mt-1 text-sm text-gray-500">
                                {% if not inventory_settings.enable_viewing_for_enquiry %}
                                    Viewing/test drive option is currently disabled.
                                {% endif %}
                            </p>
                        {% endif %}
                    {% endif %}
                </div>

                {# Appointment Date and Time Fields Container #}
                <div id="appointment-fields-container" class="contents">
                    {# Appointment Date Field #}
                    <div class="form-group">
                        <label for="{{ form.appointment_date.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.appointment_date.label }}
                        </label>
                        {{ form.appointment_date }}
                        {% if form.appointment_date.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.appointment_date.help_text }}</p>
                        {% endif %}
                        {% for error in form.appointment_date.errors %}
                            <p class="text-red-600 text-sm italic">{{ error }}</p>
                        {% endfor %}
                    </div>

                    {# Appointment Time Field - Now a regular select #}
                    <div class="form-group">
                        <label for="{{ form.appointment_time.id_for_label }}" class="block text-sm font-medium text-gray-700">
                            {{ form.appointment_time.label }}
                        </label>
                        <select id="{{ form.appointment_time.id_for_label }}" name="{{ form.appointment_time.name }}"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm
                                       focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm text-gray-900 border">
                            <option value="">---------</option> {# Default empty option #}
                        </select>
                        {% if form.appointment_time.help_text %}
                            <p class="mt-1 text-sm text-gray-500">{{ form.appointment_time.help_text }}</p>
                        {% endif %}
                        {% for error in form.appointment_time.errors %}
                            <p class="text-red-600 text-sm italic">{{ error }}</p>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4 border-b pb-2">Additional Information</h3>
            <div class="grid grid-cols-1 gap-4">
                {# Customer Notes Field #}
                <div class="form-group">
                    <label for="{{ form.customer_notes.id_for_label }}" class="block text-sm font-medium text-gray-700">
                        {{ form.customer_notes.label }}
                    </label>
                    {{ form.customer_notes }}
                    {% if form.customer_notes.help_text %}
                        <p class="mt-1 text-sm text-gray-500">{{ form.customer_notes.help_text }}</p>
                    {% endif %}
                    {% for error in form.customer_notes.errors %}
                        <p class="text-red-600 text-sm italic">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>

            <div class="flex justify-between mt-8">
                <a href="{% url 'inventory:step1_sales_profile' %}"
                   class="px-6 py-3 border border-gray-300 text-gray-700 font-semibold rounded-md shadow-sm
                          hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Previous: Your Details
                </a>
                <button type="submit"
                        class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-md
                               hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    {% if temp_booking.deposit_required_for_flow %}
                        Next: Payment
                    {% else %}
                        Submit Enquiry
                    {% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <!-- Flatpickr JS for Date -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const appointmentDateInput = document.getElementById('id_appointment_date');
            const appointmentTimeSelect = document.getElementById('id_appointment_time');
            // Ensure available_dates_json exists before trying to parse
            const availableDatesJsonElement = document.getElementById('available_dates_json');
            const parsedAvailableDates = availableDatesJsonElement ? JSON.parse(availableDatesJsonElement.textContent) : [];

            const requestViewingRadios = document.querySelectorAll('input[name="request_viewing"]');
            const appointmentFieldsContainer = document.getElementById('appointment-fields-container');
            const depositRequiredForFlow = '{{ temp_booking.deposit_required_for_flow|lower }}'; // Pass boolean from Django

            let flatpickrInstance; // Declare variable to hold flatpickr instance

            function toggleAppointmentFields() {
                const selectedValue = document.querySelector('input[name="request_viewing"]:checked').value;
                // If deposit is required, always show fields. Otherwise, show if 'yes' is selected.
                const shouldShow = depositRequiredForFlow === 'true' || (selectedValue === 'yes'); // Compare with string 'true'

                if (shouldShow) {
                    appointmentFieldsContainer.style.display = 'contents'; // Show
                    // Ensure date picker is re-initialized if it was destroyed or hidden
                    if (!flatpickrInstance) {
                        initializeFlatpickr();
                    } else {
                        // If it's already initialized but was hidden, ensure it's functional
                        // This will re-trigger onChange if date is pre-filled and valid
                        if (appointmentDateInput.value && parsedAvailableDates.includes(appointmentDateInput.value)) {
                            flatpickrInstance.setDate(appointmentDateInput.value, true);
                        } else {
                            flatpickrInstance.clear(); // Clear if pre-filled date is invalid or empty
                        }
                    }
                    // If a date is already selected (or freshly set by flatpickr), try to load times
                    if (appointmentDateInput.value) {
                         fetchAvailableTimes(appointmentDateInput.value);
                    } else {
                         // Clear time options if no date is selected
                         appointmentTimeSelect.innerHTML = '<option value="">---------</option>';
                    }
                } else {
                    appointmentFieldsContainer.style.display = 'none'; // Hide
                    // Optionally clear date/time values when hiding
                    appointmentDateInput.value = '';
                    appointmentTimeSelect.innerHTML = '<option value="">---------</option>';
                    if (flatpickrInstance) {
                        flatpickrInstance.destroy(); // Destroy flatpickr instance when hiding
                        flatpickrInstance = null; // Clear the instance
                    }
                }
            }

            function initializeFlatpickr() {
                flatpickrInstance = flatpickr(appointmentDateInput, {
                    dateFormat: "Y-m-d",
                    minDate: "today",
                    enable: [
                        function(date) {
                            const formattedDate = flatpickr.formatDate(date, "Y-m-d");
                            return parsedAvailableDates.includes(formattedDate);
                        }
                    ],
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            fetchAvailableTimes(dateStr);
                        } else {
                            // Clear time options if date is cleared
                            appointmentTimeSelect.innerHTML = '<option value="">---------</option>';
                        }
                    }
                });
            }


            // Function to fetch available times via AJAX
            function fetchAvailableTimes(selectedDate) {
                const url = "{% url 'inventory:ajax_get_appointment_times' %}?date=" + selectedDate;
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        appointmentTimeSelect.innerHTML = '<option value="">---------</option>'; // Clear existing options
                        if (data.available_times && data.available_times.length > 0) {
                            data.available_times.forEach(time => {
                                const option = document.createElement('option');
                                option.value = time.value;
                                option.textContent = time.text;
                                appointmentTimeSelect.appendChild(option);
                            });
                        } else {
                            const option = document.createElement('option');
                            option.value = "";
                            option.textContent = "No times available for this date";
                            appointmentTimeSelect.appendChild(option);
                        }

                        // If there was a pre-selected time from temp_booking, try to select it
                        const initialTime = "{{ temp_booking.appointment_time|time:'H:i' }}";
                        if (initialTime && initialTime !== 'None') {
                            const matchingOption = Array.from(appointmentTimeSelect.options).find(option => option.value === initialTime);
                            if (matchingOption) {
                                appointmentTimeSelect.value = initialTime;
                            }
                        }

                    })
                    .catch(error => {
                        console.error('Error fetching available times:', error);
                        appointmentTimeSelect.innerHTML = '<option value="">Error loading times</option>';
                    });
            }

            // Add event listeners to radio buttons
            requestViewingRadios.forEach(radio => {
                radio.addEventListener('change', toggleAppointmentFields);
            });

            // Initial setup based on default/pre-selected value and deposit_required_for_flow
            toggleAppointmentFields(); // Set initial visibility of appointment fields

            // If an appointment date is pre-filled, trigger the time fetch (handled by toggleAppointmentFields now)
            // No need for a separate call here.
        });
    </script>
{% endblock %}
