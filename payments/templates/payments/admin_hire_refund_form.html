{% extends "dashboard/admin_layout.html" %}

{% block extra_css %}
{{ block.super }}
<style>
    .required-indicator {
        color: red;
        margin-left: 5px;
    }
    /* Removed .refund-info-box custom styling as requested */
    .hidden {
        display: none;
    }
</style>
{% endblock %}

{% block admin_main_content %}
    {% load static %}{# Load static files for CSS #}
    <link rel="stylesheet" href="{% static 'css/service_type_styles.css' %}"> {# Re-using this CSS for general form styling #}

    <div class="service-booking-container">
        <div class="booking-progress">
            <h2>{{ title }}</h2>
        </div>
        <p class="mb-4">Use this form to {% if hire_refund_request %}edit{% else %}create{% endif %} a hire refund request.</p>

        {# Display Django messages (e.g., success, error) #}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}

        <form method="post" class="needs-validation" novalidate>
            {% csrf_token %} {# Django's CSRF protection token #}

            {# General Refund Request Information Fieldset #}
            <fieldset class="form-group border p-3 mb-4 rounded">
                <legend class="w-auto px-2">Refund Request Details</legend>

                {# hire_booking field - This is the dropdown for selecting a booking #}
                <div class="form-group mb-3">
                    <label for="{{ form.hire_booking.id_for_label }}">
                        {{ form.hire_booking.label }}
                        {% if form.hire_booking.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.hire_booking }} {# Renders the select dropdown #}
                    {# Display any errors for this field #}
                    {% if form.hire_booking.errors %}<div class="invalid-feedback d-block">{% for error in form.hire_booking.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <small class="form-text text-muted">{{ form.hire_booking.help_text }}</small>
                </div>

                {# Section for dynamically displaying selected booking details #}
                <div id="bookingDetailsDisplay" class="hidden">
                    <h4>Selected Booking Details</h4>
                    <p><strong>Booking Reference:</strong> <span id="detailBookingRef"></span></p>
                    <p><strong>Customer Name:</strong> <span id="detailCustomerName"></span></p>
                    <p><strong>Pickup:</strong> <span id="detailPickupDate"></span> at <span id="detailPickupTime"></span></p>
                    <p><strong>Return:</strong> <span id="detailReturnDate"></span> at <span id="detailReturnTime"></span></p>
                    <p><strong>Motorcycle:</strong> <span id="detailMotorcycle"></span></p>
                    <p><strong>Booking Status:</strong> <span id="detailBookingStatus"></span></p>
                    <p><strong>Payment Method:</strong> <span id="detailPaymentMethod"></span></p>
                    <p><strong>Payment Date:</strong> <span id="detailPaymentDate"></span></p>
                    <p><strong>Payment Amount:</strong> <span id="detailPaymentAmount"></span></p>
                    {# NEW: Display the latest refund request status for this booking #}
                    <p><strong>Latest Refund Request Status:</strong> <span id="detailRefundRequestStatus"></span></p>
                </div>

                {# Section for displaying calculated entitled refund information #}
                <div id="entitledRefundInfo" class="mb-3 hidden">
                    <p><strong>Calculated Entitled Refund:</strong> <span id="entitledRefundAmount"></span></p>
                    <p><strong>Calculation Details:</strong> <span id="refundCalculationDetails"></span></p>
                </div>

                {# reason field #}
                <div class="form-group mb-3">
                    <label for="{{ form.reason.id_for_label }}">
                        {{ form.reason.label }}
                        {% if form.reason.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.reason }}
                    {% if form.reason.errors %}<div class="invalid-feedback d-block">{% for error in form.reason.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <small class="form-text text-muted">{{ form.reason.help_text }}</small>
                </div>

                {# staff_notes field #}
                <div class="form-group mb-3">
                    <label for="{{ form.staff_notes.id_for_label }}">
                        {{ form.staff_notes.label }}
                        {% if form.staff_notes.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.staff_notes }}
                    {% if form.staff_notes.errors %}<div class="invalid-feedback d-block">{% for error in form.staff_notes.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <small class="form-text text-muted">{{ form.staff_notes.help_text }}</small>
                </div>

                {# amount_to_refund field #}
                <div class="form-group mb-3">
                    <label for="{{ form.amount_to_refund.id_for_label }}">
                        {{ form.amount_to_refund.label }}
                        {% if form.amount_to_refund.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.amount_to_refund }}
                    {% if form.amount_to_refund.errors %}<div class="invalid-feedback d-block">{% for error in form.amount_to_refund.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <small class="form-text text-muted">{{ form.amount_to_refund.help_text }}</small>
                </div>

                {# is_admin_initiated field - REMOVED from direct rendering as it's set in the view #}
                {% comment %}
                <div class="form-group form-check mb-3">
                    {{ form.is_admin_initiated }}
                    <label class="form-check-label" for="{{ form.is_admin_initiated.id_for_label }}">
                        {{ form.is_admin_initiated.label }}
                    </label>
                    {% if form.is_admin_initiated.errors %}<div class="invalid-feedback d-block">{% for error in form.is_admin_initiated.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <small class="form-text text-muted">{{ form.is_admin_initiated.help_text }}</small>
                </div>
                {% endcomment %}

            </fieldset>

            {# Form submission buttons #}
            <button type="submit" class="btn btn-success">Save Refund Request</button>
            <a href="{% url 'dashboard:admin_hire_refund_management' %}" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Function to add Bootstrap's 'is-invalid' class for form errors dynamically
            document.querySelectorAll('.invalid-feedback').forEach(function(feedback) {
                const formControl = feedback.previousElementSibling;
                if (formControl && (formControl.classList.contains('form-control') || formControl.classList.contains('form-check-input') || formControl.classList.contains('form-control-file'))) {
                    formControl.classList.add('is-invalid');
                }
            });
            document.querySelectorAll('input, select, textarea').forEach(function(input) {
                if (input.nextElementSibling && input.nextElementSibling.classList.contains('invalid-feedback')) {
                    input.classList.add('is-invalid');
                }
                if (input.type === 'checkbox' && input.closest('.form-check') && input.closest('.form-check').querySelector('.invalid-feedback')) {
                    input.classList.add('is-invalid');
                }
            });

            const hireBookingSelect = document.getElementById('id_hire_booking');
            const bookingDetailsDisplay = document.getElementById('bookingDetailsDisplay');
            const entitledRefundInfoDiv = document.getElementById('entitledRefundInfo');
            const entitledRefundAmountSpan = document.getElementById('entitledRefundAmount');
            const refundCalculationDetailsSpan = document.getElementById('refundCalculationDetails');
            const amountToRefundInput = document.getElementById('id_amount_to_refund');


            // Function to update booking details display with fetched data
            function updateBookingDetails(details) {
                if (details) {
                    document.getElementById('detailBookingRef').textContent = details.booking_reference || 'N/A';
                    document.getElementById('detailCustomerName').textContent = details.customer_name || 'N/A';
                    document.getElementById('detailPickupDate').textContent = details.pickup_date || 'N/A';
                    document.getElementById('detailPickupTime').textContent = details.pickup_time || 'N/A';
                    document.getElementById('detailReturnDate').textContent = details.return_date || 'N/A';
                    document.getElementById('detailReturnTime').textContent = details.return_time || 'N/A';
                    document.getElementById('detailMotorcycle').textContent = `${details.motorcycle_year || ''} ${details.motorcycle_brand || ''} ${details.motorcycle_model || ''}`.trim() || 'N/A';
                    document.getElementById('detailBookingStatus').textContent = details.booking_status || 'N/A';
                    document.getElementById('detailPaymentMethod').textContent = details.payment_method || 'N/A';
                    document.getElementById('detailPaymentDate').textContent = details.payment_date || 'N/A';
                    document.getElementById('detailPaymentAmount').textContent = details.payment_amount ? `$${details.payment_amount.toFixed(2)}` : 'N/A';
                    // NEW: Populate the latest refund request status
                    document.getElementById('detailRefundRequestStatus').textContent = details.refund_request_status_for_booking || 'N/A';
                    bookingDetailsDisplay.classList.remove('hidden');

                    // Update and show entitled refund info
                    if (details.entitled_refund_amount !== undefined && details.entitled_refund_amount !== null) {
                        entitledRefundAmountSpan.textContent = `$${details.entitled_refund_amount.toFixed(2)}`;
                        refundCalculationDetailsSpan.textContent = details.refund_calculation_details || 'N/A';
                        entitledRefundInfoDiv.classList.remove('hidden');
                    } else {
                        entitledRefundInfoDiv.classList.add('hidden');
                    }

                    // Set default amount to refund to 0.00 if it's a new request and no value is set
                    if (!amountToRefundInput.value) {
                         amountToRefundInput.value = '0.00';
                    }

                } else {
                    // Hide sections if no booking is selected or details are null
                    bookingDetailsDisplay.classList.add('hidden');
                    entitledRefundInfoDiv.classList.add('hidden');
                }
            }

            // Function to fetch booking details from the API endpoint
            async function fetchBookingDetails(bookingId) {
                if (!bookingId) {
                    updateBookingDetails(null); // Clear details if no booking selected
                    return;
                }

                try {
                    // Use Django's URL tag for robustness, replacing '0' with the actual bookingId
                    const url = `{% url 'payments:api_hire_booking_details' pk=0 %}`.replace('0', bookingId);
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    updateBookingDetails(data); // Update the display with fetched data
                } catch (error) {
                    console.error('Error fetching booking details:', error);
                    updateBookingDetails(null); // Clear details on error
                    // Optionally display an error message to the user, e.g., using a modal
                }
            }

            // Event listener for when the hire_booking dropdown changes
            hireBookingSelect.addEventListener('change', function() {
                fetchBookingDetails(this.value);
            });

            // Initial load: if a booking is already selected (e.g., when editing an existing refund request),
            // fetch and display its details.
            if (hireBookingSelect.value) {
                fetchBookingDetails(hireBookingSelect.value);
            } else {
                // If no booking is selected on initial load (e.g., creating a new refund request),
                // ensure the refund info section is hidden and amount to refund is set to 0.00.
                entitledRefundInfoDiv.classList.add('hidden');
                amountToRefundInput.value = '0.00';
            }
        });
    </script>
{% endblock %}

