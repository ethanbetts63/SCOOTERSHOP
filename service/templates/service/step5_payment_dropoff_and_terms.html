{% extends "core/layout.html" %}
{% load static %}

{% block title %}Book Service - Step {{ step|default:'5' }} - Drop-off & Payment{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/booking_styles.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* Style for required form field labels */
    .required-label::after {
        content: " *";
        color: red;
    }
    /* Custom styles for message tags */
    .messages-container ul {
        list-style-type: none;
        padding: 0;
    }
    .messages-container li {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    .messages-container li.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .messages-container li.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .messages-container li.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
    }
    .messages-container li.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    /* Ensure invalid-feedback for custom select is visible */
    .was-validated .form-select:invalid ~ .invalid-feedback, .form-select.is-invalid ~ .invalid-feedback {
      display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="service-booking-container max-w-2xl mx-auto p-4 md:p-6 bg-white shadow-lg rounded-lg">
    
    <!-- Progress Indicator -->
    <div class="booking-progress text-center mb-6">
        <h2 class="text-2xl font-semibold text-gray-700">Book Service - Step {{ step }} of {{ total_steps }}</h2>
        <p class="text-gray-600">Drop-off, Payment & Terms</p>
        <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
            <div class="bg-blue-600 h-2.5 rounded-full" ></div>
        </div>
    </div>

    <hr class="mb-6">

    <!-- Django Messages -->
    {% if messages %}
    <div class="messages-container mb-4">
        <ul>
            {% for message in messages %}
            <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <form method="post" id="payment-form" novalidate>
        {% csrf_token %}

        <!-- Form-wide Non-field Errors -->
        {% if form.non_field_errors %}
            <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
                {% for error in form.non_field_errors %}
                    <strong class="font-bold">Error:</strong>
                    <span class="block sm:inline">{{ error }}</span>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Drop-off Date and Time Fields -->
        <fieldset class="mb-6">
            <legend class="text-xl font-semibold text-gray-800 mb-4">Drop-off Details</legend>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="{{ form.dropoff_date.id_for_label }}" class="block text-sm font-medium text-gray-700 required-label">{{ form.dropoff_date.label }}</label>
                    <input type="text"
                           name="{{ form.dropoff_date.name }}"
                           id="{{ form.dropoff_date.id_for_label }}"
                           class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm {% if form.dropoff_date.errors %}border-red-500{% endif %}"
                           placeholder="Click to select a date"
                           data-min-date="{{ min_dropoff_date }}"
                           data-max-date="{{ max_dropoff_date }}"
                           value="{{ form.dropoff_date.value|default_if_none:''|date:'Y-m-d' }}">
                    {% for error in form.dropoff_date.errors %}
                        <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
                <div>
                    <label for="{{ form.dropoff_time.id_for_label }}" class="block text-sm font-medium text-gray-700 required-label">{{ form.dropoff_time.label }}</label>
                    <select name="{{ form.dropoff_time.name }}"
                            id="{{ form.dropoff_time.id_for_label }}"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm {% if form.dropoff_time.errors %}border-red-500{% endif %}"
                            disabled>
                        <option value="">Select a date first</option>
                    </select>
                    {% for error in form.dropoff_time.errors %}
                         <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
                    {% endfor %}
                </div>
            </div>
        </fieldset>

        <!-- Payment Method Selection -->
        <fieldset class="mb-6">
            <legend class="text-xl font-semibold text-gray-800 mb-4">{{ form.payment_option.label }}</legend>
            {% for radio in form.payment_option %}
            <div class="flex items-center mb-2">
                {{ radio.tag }}
                <label for="{{ radio.id_for_label }}" class="ml-3 block text-sm font-medium text-gray-700">
                    {{ radio.choice_label }}
                </label>
            </div>
            {% endfor %}
            {% for error in form.payment_option.errors %}
                <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
        </fieldset>

        <!-- Terms and Conditions -->
        <fieldset>
             <div class="flex items-start">
                <div class="flex items-center h-5">
                   {{ form.service_terms_accepted }}
                </div>
                <div class="ml-3 text-sm">
                    <label for="{{ form.service_terms_accepted.id_for_label }}" class="font-medium text-gray-700 required-label">{{ form.service_terms_accepted.label|safe }}</label>
                </div>
            </div>
            {% for error in form.service_terms_accepted.errors %}
                <p class="text-red-500 text-xs italic mt-1">{{ error }}</p>
            {% endfor %}
        </fieldset>
        
        <!-- Navigation Buttons -->
        <div class="flex justify-between items-center mt-8 pt-6 border-t">
            <a href="{% url 'service:service_book_step4' %}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                Back
            </a>
            <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">
                Continue to Final Summary
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dateInput = document.getElementById('{{ form.dropoff_date.id_for_label }}');
    const timeSelect = document.getElementById('{{ form.dropoff_time.id_for_label }}');
    const getTimesUrl = '{{ get_times_url }}';

    // Initialize Flatpickr date picker
    const fp = flatpickr(dateInput, {
        altInput: true,
        altFormat: "F j, Y",
        dateFormat: "Y-m-d",
        minDate: dateInput.dataset.minDate,
        maxDate: dateInput.dataset.maxDate,
        onChange: function(selectedDates, dateStr, instance) {
            if (dateStr) {
                fetchAvailableTimes(dateStr);
            } else {
                resetTimeSelect();
            }
        },
    });

    function resetTimeSelect(message = 'Select a date first') {
        timeSelect.innerHTML = `<option value="">${message}</option>`;
        timeSelect.disabled = true;
    }

    async function fetchAvailableTimes(selectedDate) {
        resetTimeSelect('Loading times...');
        
        try {
            const response = await fetch(`${getTimesUrl}?date=${selectedDate}`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();
            
            if (data.available_times && data.available_times.length > 0) {
                timeSelect.innerHTML = '<option value="">Select a time</option>';
                const previousTimeValue = '{{ form.dropoff_time.value|default_if_none:""|date:"H:i:s" }}';

                data.available_times.forEach(time => {
                    const option = document.createElement('option');
                    option.value = time.value;
                    option.textContent = time.text; // Assumes text is formatted time
                    
                    if (previousTimeValue && previousTimeValue === time.value) {
                        option.selected = true;
                    }
                    timeSelect.appendChild(option);
                });
                timeSelect.disabled = false;
            } else {
                resetTimeSelect('No times available');
            }
        } catch (error) {
            console.error('Error fetching available times:', error);
            resetTimeSelect('Error loading times');
        }
    }

    // If a date is already in the input (e.g., from form error reload), fetch times.
    if (dateInput.value) {
        fetchAvailableTimes(dateInput.value);
    }
});
</script>
{% endblock %}
