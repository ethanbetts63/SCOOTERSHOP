{% extends "dashboard/admin_layout.html" %}

{% block admin_main_content %}
<div class="container mt-4">
    <h1>{{ page_title }} - Existing User</h1>
    <hr>

    {% if messages %}
        <div class="alert alert-info">
            {% for message in messages %}
                <p{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="admin-booking-user-form">
        {% csrf_token %}

        <div class="card mb-4">
            <div class="card-header">
                <h3>Customer Selection</h3>
            </div>
            <div class="card-body">
                {# Move the existing customer dropdown first #}
                <div class="form-group">
                    {% if form.user.field.required %}<span class="required-indicator">*</span> {% endif %}<label for="{{ form.user.id_for_label }}" class="form-label">{{ form.user.label }}</label>
                    {{ form.user }}
                    {% if form.user.errors %}
                        <div class="text-danger">
                            {% for error in form.user.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>

                {# Place the Add New Customer button below the dropdown #}
                <div class="form-group">
                    <a href="{% url 'users:admin_create_user' %}" class="btn btn-secondary mb-2" id="add-customer-button">Add New Customer</a>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Customer Details (Editable)</h3>
            </div>
            <div class="card-body" id="user-details-section">
                <p id="customer-details-instructions">Select an existing customer to load their details. Details can be edited and will update the user's profile upon booking creation.</p>
                <div id="ajax-error-message" class="alert alert-danger" style="display: none;">
                    Error loading customer details. Please enter manually or try again.
                </div>

                <div class="form-group">
                    {# Removed "Update" from the label #}
                    <label for="{{ form.user_first_name.id_for_label }}" class="form-label">First Name</label>
                    {{ form.user_first_name }}
                    {% if form.user_first_name.errors %}<div class="text-danger">{% for error in form.user_first_name.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {# Removed "Update" from the label #}
                    <label for="{{ form.user_last_name.id_for_label }}" class="form-label">Last Name</label>
                    {{ form.user_last_name }}
                    {% if form.user_last_name.errors %}<div class="text-danger">{% for error in form.user_last_name.errors %}{{ error }}{{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {# Removed "Update" from the label #}
                    <label for="{{ form.user_email.id_for_label }}" class="form-label">Email</label>
                    {{ form.user_email }}
                    {% if form.user_email.errors %}<div class="text-danger">{% for error in form.user_email.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {# Removed "Update" from the label #}
                    <label for="{{ form.user_phone_number.id_for_label }}" class="form-label">Phone Number</label>
                    {{ form.user_phone_number }}
                    {% if form.user_phone_number.errors %}<div class="text-danger">{% for error in form.user_phone_number.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Motorcycle Details</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {% if form.bike_selection_type.field.required %}<span class="required-indicator">*</span> {% endif %}{{ form.bike_selection_type.label_tag }}
                    {{ form.bike_selection_type }}
                </div>

                <div id="existing-motorcycle-section">
                    <div class="form-group">
                         {# existing_motorcycle is conditionally required in clean method #}
                        <span class="required-indicator">*</span> <label for="{{ form.existing_motorcycle.id_for_label }}" class="form-label">{{ form.existing_motorcycle.label }}</label>
                        {{ form.existing_motorcycle }}
                        {% if form.existing_motorcycle.errors %}
                            <div class="text-danger">
                                {% for error in form.existing_motorcycle.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div id="new-motorcycle-section">
                    <h4>Motorcycle Details</h4>
                    <div class="form-group">
                        {# new_bike_make is conditionally required in clean method #}
                        <span class="required-indicator">*</span> <label for="{{ form.new_bike_make.id_for_label }}" class="form-label">{{ form.new_bike_make.label }}</label>
                        {{ form.new_bike_make }}
                        {% if form.new_bike_make.errors %}<div class="text-danger">{% for error in form.new_bike_make.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                         {# new_bike_model is conditionally required in clean method #}
                        <span class="required-indicator">*</span> <label for="{{ form.new_bike_model.id_for_label }}" class="form-label">{{ form.new_bike_model.label }}</label>
                        {{ form.new_bike_model }}
                        {% if form.new_bike_model.errors %}<div class="text-danger">{% for error in form.new_bike_model.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {# new_bike_year is conditionally required in clean method #}
                        <span class="required-indicator">*</span> <label for="{{ form.new_bike_year.id_for_label }}" class="form-label">{{ form.new_bike_year.label }}</label>
                        {{ form.new_bike_year }}
                        {% if form.new_bike_year.errors %}<div class="text-danger">{% for error in form.new_bike_year.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {# Rego is not required #}
                        <label for="{{ form.new_bike_rego.id_for_label }}" class="form-label">{{ form.new_bike_rego.label }}</label>
                        {{ form.new_bike_rego }}
                        {% if form.new_bike_rego.errors %}<div class="text-danger">{% for error in form.new_bike_rego.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                     <div class="form-group">
                        {# VIN is not required #}
                        <label for="{{ form.new_bike_vin_number.id_for_label }}" class="form-label">{{ form.new_bike_vin_number.label }}</label>
                        {{ form.new_bike_vin_number }}
                        {% if form.new_bike_vin_number.errors %}<div class="text-danger">{% for error in form.new_bike_vin_number.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {# Odometer is not required #}
                        <label for="{{ form.new_bike_odometer.id_for_label }}" class="form-label">{{ form.new_bike_odometer.label }}</label>
                        {{ form.new_bike_odometer }}
                        {% if form.new_bike_odometer.errors %}<div class="text-danger">{% for error in form.new_bike_odometer.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {# Transmission is not required #}
                        <label for="{{ form.new_bike_transmission.id_for_label }}" class="form-label">{{ form.new_bike_transmission.label }}</label>
                        {{ form.new_bike_transmission }}
                        {% if form.new_bike_transmission.errors %}<div class="text-danger">{% for error in form.new_bike_transmission.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
        <br>

        <div class="card mb-4">
            <div class="card-header">
                <h3>Service Details</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {% if form.service_type.field.required %}<span class="required-indicator">*</span> {% endif %}<label for="{{ form.service_type.id_for_label }}" class="form-label">{{ form.service_type.label }}</label>
                    {{ form.service_type }}
                    {% if form.service_type.errors %}<div class="text-danger">{% for error in form.service_type.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {% if form.appointment_date.field.required %}<span class="required-indicator">*</span> {% endif %}<label for="{{ form.appointment_date.id_for_label }}" class="form-label">{{ form.appointment_date.label }}</label>
                    {{ form.appointment_date }}
                    {% if form.appointment_date.errors %}<div class="text-danger">{% for error in form.appointment_date.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                     {# Booking comments are not required #}
                    <label for="{{ form.booking_comments.id_for_label }}" class="form-label">{{ form.booking_comments.label }}</label>
                    {{ form.booking_comments }}
                    {% if form.booking_comments.errors %}<div class="text-danger">{% for error in form.booking_comments.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <button type="submit" class="btn btn-primary">Create Booking for User</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/service_booking_admin_user.js' %}"></script>   
{% endblock %}