{% extends "dashboard/admin_layout.html" %}

{% block admin_main_content %}
<div class="container mt-4">
    <h1>{{ page_title }} - Existing User</h1>
    <hr>

    {% if messages %}
        <div class="alert alert-info">
            {% for message in messages %}
                <p{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}

    <form method="post" id="admin-booking-user-form">
        {% csrf_token %}

        {# Existing Customer Selection #}
        <div class="card mb-4">
            <div class="card-header">
                <h3>Customer Selection</h3>
            </div>
            <div class="card-body">
                {# Add "Add Customer" button - Link to new customer creation if needed #}
                <div class="form-group">
                    <a href="{% url 'users:admin_create_user' %}" class="btn btn-secondary mb-2" id="add-customer-button">Add New Customer</a>
                    {# Ensure 'users:admin_create_user' is a valid URL name for adding users #}
                </div>

                <div class="form-group">
                    {{ form.user.label_tag }}
                    {{ form.user }}
                    {% if form.user.errors %}
                        <div class="text-danger">
                            {% for error in form.user.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        {# Customer Details Section - Populated by AJAX, Editable #}
        {# This section is now editable to update user details if necessary #}
        <div class="card mb-4">
            <div class="card-header">
                <h3>Customer Details (Editable)</h3> {# Changed header for clarity #}
            </div>
            <div class="card-body" id="user-details-section">
                <p id="customer-details-instructions">Select an existing customer to load their details. Details can be edited and will update the user's profile upon booking creation.</p>
                <div id="ajax-error-message" class="alert alert-danger" style="display: none;">
                    Error loading customer details. Please enter manually or try again.
                </div>

                {# These fields will be populated by AJAX for existing users and are now editable #}
                <div class="form-group">
                    {{ form.user_first_name.label_tag }}
                    {{ form.user_first_name }}
                    {% if form.user_first_name.errors %}<div class="text-danger">{% for error in form.user_first_name.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.user_last_name.label_tag }}
                    {{ form.user_last_name }}
                    {% if form.user_last_name.errors %}<div class="text-danger">{% for error in form.user_last_name.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.user_email.label_tag }}
                    {{ form.user_email }}
                    {% if form.user_email.errors %}<div class="text-danger">{% for error in form.user_email.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.user_phone_number.label_tag }}
                    {{ form.user_phone_number }}
                    {% if form.user_phone_number.errors %}<div class="text-danger">{% for error in form.user_phone_number.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            </div>
        </div>

        {# Motorcycle Details Section for Existing User #}
        <div class="card mb-4">
            <div class="card-header">
                <h3>Motorcycle Details</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {{ form.bike_selection_type.label_tag }}
                    {{ form.bike_selection_type }} {# Should default/show 'existing' or 'new' #}
                </div>

                <div id="existing-motorcycle-section">
                    <div class="form-group">
                        {{ form.existing_motorcycle.label_tag }}
                        {{ form.existing_motorcycle }}
                        {% if form.existing_motorcycle.errors %}
                            <div class="text-danger">
                                {% for error in form.existing_motorcycle.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div id="new-motorcycle-section"> {# Shown for 'new' or when 'existing' bike is selected to show details #}
                    <h4>Motorcycle Details</h4>
                    <div class="form-group">
                        {{ form.new_bike_make.label_tag }}
                        {{ form.new_bike_make }}
                        {% if form.new_bike_make.errors %}<div class="text-danger">{% for error in form.new_bike_make.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_model.label_tag }}
                        {{ form.new_bike_model }}
                        {% if form.new_bike_model.errors %}<div class="text-danger">{% for error in form.new_bike_model.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_year.label_tag }}
                        {{ form.new_bike_year }}
                        {% if form.new_bike_year.errors %}<div class="text-danger">{% for error in form.new_bike_year.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_rego.label_tag }}
                        {{ form.new_bike_rego }}
                        {% if form.new_bike_rego.errors %}<div class="text-danger">{% for error in form.new_bike_rego.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_vin_number.label_tag }}
                        {{ form.new_bike_vin_number }}
                        {% if form.new_bike_vin_number.errors %}<div class="text-danger">{% for error in form.new_bike_vin_number.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_odometer.label_tag }}
                        {{ form.new_bike_odometer }}
                        {% if form.new_bike_odometer.errors %}<div class="text-danger">{% for error in form.new_bike_odometer.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                    <div class="form-group">
                        {{ form.new_bike_transmission.label_tag }}
                        {{ form.new_bike_transmission }}
                        {% if form.new_bike_transmission.errors %}<div class="text-danger">{% for error in form.new_bike_transmission.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                </div>
            </div>
        </div>
        <br>

        {# Service Details Section - Common #}
        <div class="card mb-4">
            <div class="card-header">
                <h3>Service Details</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    {{ form.service_type.label_tag }}
                    {{ form.service_type }}
                    {% if form.service_type.errors %}<div class="text-danger">{% for error in form.service_type.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.appointment_datetime.label_tag }}
                    {{ form.appointment_datetime }}
                    {% if form.appointment_datetime.errors %}<div class="text-danger">{% for error in form.appointment_datetime.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.preferred_contact.label_tag }}
                    {{ form.preferred_contact }}
                    {% if form.preferred_contact.errors %}<div class="text-danger">{% for error in form.preferred_contact.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    {{ form.booking_comments.label_tag }}
                    {{ form.booking_comments }}
                    {% if form.booking_comments.errors %}<div class="text-danger">{% for error in form.booking_comments.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            </div>
        </div>

        <div class="form-group mb-4">
            <button type="submit" class="btn btn-primary">Create Booking for User</button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userSelect = document.getElementById('id_user');
    const customerDetailsInstructions = document.getElementById('customer-details-instructions');
    const ajaxErrorMessage = document.getElementById('ajax-error-message');

    // Element selections for the user details fields
    const userFirstNameInput = document.getElementById('id_user_first_name');
    const userLastNameInput = document.getElementById('id_user_last_name');
    const userEmailInput = document.getElementById('id_user_email');
    const userPhoneNumberInput = document.getElementById('id_user_phone_number');

    const bikeSelectionTypeRadios = document.querySelectorAll('input[name="bike_selection_type"]');
    const existingMotorcycleSection = document.getElementById('existing-motorcycle-section');
    const newMotorcycleSection = document.getElementById('new-motorcycle-section'); // This is where bike details are shown/entered/edited
    const existingMotorcycleSelect = document.getElementById('id_existing_motorcycle');

    const newBikeMakeInput = document.getElementById('id_new_bike_make');
    const newBikeModelInput = document.getElementById('id_new_bike_model');
    const newBikeYearInput = document.getElementById('id_new_bike_year');
    const newBikeRegoInput = document.getElementById('id_new_bike_rego');
    const newBikeVinNumberInput = document.getElementById('id_new_bike_vin_number');
    const newBikeOdometerInput = document.getElementById('id_new_bike_odometer');
    const newBikeTransmissionInput = document.getElementById('id_new_bike_transmission');

    function clearCustomerDetails() {
        userFirstNameInput.value = '';
        userLastNameInput.value = '';
        userEmailInput.value = '';
        userPhoneNumberInput.value = '';
    }

    function clearMotorcycleDetails() {
        newBikeMakeInput.value = '';
        newBikeModelInput.value = '';
        newBikeYearInput.value = '';
        newBikeRegoInput.value = '';
        newBikeVinNumberInput.value = '';
        newBikeOdometerInput.value = '';
        newBikeTransmissionInput.value = ''; // Check if this needs to be reset to default
    }

    function setMotorcycleFieldsDisabled(disabled) {
        newBikeMakeInput.disabled = disabled;
        newBikeModelInput.disabled = disabled;
        newBikeYearInput.disabled = disabled;
        newBikeRegoInput.disabled = disabled;
        newBikeVinNumberInput.disabled = disabled;
        newBikeOdometerInput.disabled = disabled;
        newBikeTransmissionInput.disabled = disabled;
    }


    function toggleBikeFields() {
        const selectedBikeSelectionType = document.querySelector('input[name="bike_selection_type"]:checked').value;

        if (selectedBikeSelectionType === 'existing') {
            existingMotorcycleSection.style.display = 'block';
            newMotorcycleSection.style.display = 'block'; // Keep this visible to show selected bike's details

            if (existingMotorcycleSelect.value) {
                populateMotorcycleDetails(existingMotorcycleSelect.value);
                // --- IMPORTANT: Disable new bike fields when an existing bike is selected ---
                setMotorcycleFieldsDisabled(true);
            } else {
                clearMotorcycleDetails();
                // --- Enable new bike fields if 'existing' is selected but no bike is chosen (allows adding a new one) ---
                setMotorcycleFieldsDisabled(false);
            }
        } else { // 'new'
            existingMotorcycleSection.style.display = 'block'; // Still show dropdown, user might switch back
            newMotorcycleSection.style.display = 'block'; // For entering new bike details
            clearMotorcycleDetails(); // Clear fields for new entry
            setMotorcycleFieldsDisabled(false); // Enable fields for new bike entry
            existingMotorcycleSelect.value = ''; // Deselect any existing motorcycle
        }
    }

    // This function still runs to fetch user data and populates the now editable fields
    function populateUserDetails(userId) {
        if (userId) {
            customerDetailsInstructions.textContent = "Loading customer details...";
            ajaxErrorMessage.style.display = 'none';
            // No longer disabling fields here

            fetch("{% url 'service:get_user_details' 0 %}".replace('/0/', '/' + userId + '/'))
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok for user details.');
                    return response.json();
                })
                .then(data => {
                    // Populating editable fields
                    userFirstNameInput.value = data.first_name || '';
                    userLastNameInput.value = data.last_name || '';
                    userEmailInput.value = data.email || '';
                    userPhoneNumberInput.value = data.phone_number || '';
                    customerDetailsInstructions.textContent = "Customer details loaded. Edit if needed.";
                    // No longer disabling fields after loading

                    populateExistingMotorcycles(userId); // Trigger motorcycle loading
                })
                .catch(error => {
                    console.error('Error fetching user details:', error);
                    ajaxErrorMessage.textContent = 'Error loading customer details. Please enter manually.';
                    ajaxErrorMessage.style.display = 'block';
                    customerDetailsInstructions.textContent = "Could not load customer details. Please enter manually.";
                    clearCustomerDetails(); // Clear fields on error
                    // Fields remain editable to allow manual entry
                    existingMotorcycleSelect.innerHTML = '<option value="">-- Select Motorcycle --</option>';
                    existingMotorcycleSelect.disabled = true;
                    clearMotorcycleDetails();
                    setMotorcycleFieldsDisabled(false); // Allow manual entry for new bike if AJAX fails
                });
        } else {
            clearCustomerDetails(); // Clear fields
            customerDetailsInstructions.textContent = "Select an existing customer to load their details.";
            ajaxErrorMessage.style.display = 'none';
            existingMotorcycleSelect.innerHTML = '<option value="">-- Select Motorcycle --</option>';
            existingMotorcycleSelect.disabled = true;
            clearMotorcycleDetails();
            setMotorcycleFieldsDisabled(false); // Allow manual entry if no user selected
            toggleBikeFields(); // Set initial display based on default radio selection
        }
    }

    function populateExistingMotorcycles(userId) {
        if (userId) {
         
            fetch("{% url 'service:get_user_motorcycles' 0 %}".replace('/0/', '/' + userId + '/'))
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok for motorcycles.');
                    return response.json();
                })
                .then(data => {
                    existingMotorcycleSelect.innerHTML = '<option value="">-- Select Motorcycle --</option>';
                    if (data.motorcycles && data.motorcycles.length > 0) {
                        data.motorcycles.forEach(motorcycle => {
                            const option = document.createElement('option');
                            option.value = motorcycle.id;
                            option.textContent = `${motorcycle.year} ${motorcycle.make} ${motorcycle.model} (${motorcycle.rego || 'N/A'})`;
                            existingMotorcycleSelect.appendChild(option);
                        });
                         // Re-enable existing motorcycle select if there are bikes
                         existingMotorcycleSelect.disabled = false;
                    } else {
                        const option = document.createElement('option');
                        option.disabled = true;
                        option.textContent = 'No motorcycles found for this customer';
                        existingMotorcycleSelect.appendChild(option);
                        // Disable existing motorcycle select if no bikes found
                        existingMotorcycleSelect.disabled = true;
                    }
                    // After populating, check if a motorcycle was previously selected (e.g. form error)
                    const previousBikeId = existingMotorcycleSelect.dataset.selectedBike;
                    if (previousBikeId) {
                        existingMotorcycleSelect.value = previousBikeId;
                         // If a bike is selected, populate its details and enable fields for editing *if needed*
                         // For now, we keep them disabled as per toggleBikeFields logic for 'existing'
                         if (document.querySelector('input[name="bike_selection_type"]:checked').value === 'existing') {
                             populateMotorcycleDetails(previousBikeId);
                         }
                    }
                    toggleBikeFields(); // Update display based on current selection (or lack thereof)
                })
                .catch(error => {
                    console.error('Error fetching user motorcycles:', error);
                    existingMotorcycleSelect.innerHTML = '<option value="">Error loading motorcycles</option>';
                    existingMotorcycleSelect.disabled = true; // Disable on error
                    clearMotorcycleDetails();
                    setMotorcycleFieldsDisabled(false); // Allow manual entry
                    toggleBikeFields();
                });
        } else {
            existingMotorcycleSelect.innerHTML = '<option value="">-- Select Motorcycle --</option>';
            existingMotorcycleSelect.disabled = true; // Disable if no user selected
            clearMotorcycleDetails();
            setMotorcycleFieldsDisabled(false); // Allow manual entry
            toggleBikeFields();
        }
    }

    function populateMotorcycleDetails(motorcycleId) {
        if (motorcycleId) {

            fetch("{% url 'service:get_motorcycle_details' 0 %}".replace('/0/', '/' + motorcycleId + '/'))
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok for motorcycle details.');
                    return response.json();
                })
                .then(data => {
                    newBikeMakeInput.value = data.make || '';
                    newBikeModelInput.value = data.model || '';
                    newBikeYearInput.value = data.year || '';
                    newBikeRegoInput.value = data.rego || '';
                    newBikeVinNumberInput.value = data.vin_number || '';
                    newBikeOdometerInput.value = data.odometer || '';
                    newBikeTransmissionInput.value = data.transmission || '';
                    // If an existing bike is selected, enable fields for editing
                    // This is handled by toggleBikeFields now, which disables them
                    // when an existing bike is selected.
                })
                .catch(error => {
                    console.error('Error fetching motorcycle details:', error);
                    clearMotorcycleDetails();
                    setMotorcycleFieldsDisabled(false); // Allow manual entry if AJAX fails
                    // Optionally show an error message specific to motorcycle details
                });
        } else {
            // Only clear if bike selection type is 'existing' and no bike is chosen.
            // If 'new' is selected, fields should be clear for input.
            if (document.querySelector('input[name="bike_selection_type"]:checked').value === 'existing') {
                 clearMotorcycleDetails();
                 setMotorcycleFieldsDisabled(true); // Disable if no existing bike is selected
            }
        }
    }

    // Event Listeners
    userSelect.addEventListener('change', function() {
        populateUserDetails(this.value);
    });

    bikeSelectionTypeRadios.forEach(radio => {
        radio.addEventListener('change', toggleBikeFields);
    });

    existingMotorcycleSelect.addEventListener('change', function() {
        // Only populate details if 'existing' is selected and a motorcycle is chosen
        if (document.querySelector('input[name="bike_selection_type"]:checked').value === 'existing' && this.value) {
            populateMotorcycleDetails(this.value);
             // --- IMPORTANT: Disable new bike fields when an existing bike is selected ---
             setMotorcycleFieldsDisabled(true);
        } else {
             // If 'existing' is selected but no bike is chosen, clear details and enable fields
             if (document.querySelector('input[name="bike_selection_type"]:checked').value === 'existing') {
                 clearMotorcycleDetails();
                 setMotorcycleFieldsDisabled(false); // Enable if no existing bike is selected
             }
             // If 'new' is selected, the change event on existingMotorcycleSelect shouldn't do anything with populateMotorcycleDetails
        }
    });

    // Initial state setup
    // Check if a user is pre-selected (e.g. form error)
    if (userSelect.value) {
        populateUserDetails(userSelect.value);
        // Store selected bike if form reloads with errors
        if(existingMotorcycleSelect.value) {
            existingMotorcycleSelect.dataset.selectedBike = existingMotorcycleSelect.value;
        }
    } else {
        // Initial setup when the page loads with no selected user
        clearCustomerDetails(); // Clear fields
        customerDetailsInstructions.textContent = "Select an existing customer to load their details.";
        ajaxErrorMessage.style.display = 'none';
        existingMotorcycleSelect.innerHTML = '<option value="">-- Select Motorcycle --</option>';
        existingMotorcycleSelect.disabled = true; // Disable motorcycle select initially
        clearMotorcycleDetails();
        setMotorcycleFieldsDisabled(false); // Enable new bike fields by default if no user selected
        toggleBikeFields(); // Set initial display based on default radio (should be 'existing' but fields will be empty/disabled)
    }

    // Ensure bike fields are disabled correctly on initial load if 'existing' is the default and no user/bike is selected
     if (document.querySelector('input[name="bike_selection_type"]:checked').value === 'existing' && !userSelect.value) {
         setMotorcycleFieldsDisabled(false); // Should be enabled to allow adding a new bike if no existing are found
     }
});
</script>
{% endblock %}
