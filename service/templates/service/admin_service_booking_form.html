{% extends "dashboard/admin_layout.html" %}
{% load static %}

{% block extra_css %}
    {{ block.super }}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        .customer-search-results ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
            border: 1px solid #ddd;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .customer-search-results li {
            padding: 10px;
            cursor: pointer;
            background-color: #fff;
        }
        .customer-search-results li:hover {
            background-color: #f0f0f0;
        }
        .selected-item-display {
            padding: 1rem;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            margin-top: 1rem;
        }
    </style>
{% endblock %}

{% block admin_main_content %}
    <div class="container mt-4">
        <h2>Create New Service Booking</h2>

        {% if messages %}
            <div class="mb-3">
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post" id="adminBookingForm">
            {% csrf_token %}

            <input type="hidden" name="selected_profile_id" id="selected_profile_id" value="{{ selected_profile.pk|default:'' }}">
            <input type="hidden" name="selected_motorcycle_id" id="selected_motorcycle_id" value="{{ selected_motorcycle.pk|default:'' }}">

            <!-- Section 1: Customer Profile -->
            <div class="form-section mb-4 p-3 border rounded">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>1. Select Customer Profile</h3>
                    <a href="{{ create_profile_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus-circle me-1"></i> Create New Profile
                    </a>
                </div>
                <div class="mb-3">
                    <label for="profileSearch" class="form-label">Search Customer (Name, Email, Phone)</label>
                    <input type="text" class="form-control" id="profileSearch" placeholder="Start typing to search...">
                    <div id="profileSearchResults" class="customer-search-results mt-2"></div>
                </div>
                <div id="selectedProfileDisplay" class="selected-item-display d-none"></div>
            </div>

            <!-- Section 2: Customer Motorcycle -->
            <div id="motorcycleSection" class="form-section mb-4 p-3 border rounded d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>2. Select Customer Motorcycle</h3>
                    <a href="{{ create_motorcycle_url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-plus-circle me-1"></i> Add New Motorcycle
                    </a>
                </div>
                <div class="mb-3">
                    <label for="motorcycleDropdown" class="form-label">Select Motorcycle</label>
                    <select class="form-select" id="motorcycleDropdown" disabled>
                        <option value="">-- First, select a customer profile --</option>
                    </select>
                </div>
                <div id="selectedMotorcycleDisplay" class="selected-item-display d-none"></div>
            </div>

            <!-- Section 3: Booking Details -->
            <div id="bookingDetailsSection" class="form-section mb-4 p-3 border rounded d-none">
                <h3>3. Enter Booking Details</h3>
                {% for field in booking_details_form %}
                    <div class="mb-3">
                        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                        {{ field }}
                        {% if field.help_text %}
                            <div class="form-text">{{ field.help_text }}</div>
                        {% endif %}
                        {% for error in field.errors %}
                            <div class="invalid-feedback d-block">{{ error }}</div>
                        {% endfor %}
                    </div>
                {% endfor %}
                 <button type="submit" class="btn btn-success">Create Booking</button>
            </div>
        </form>
    </div>
{% endblock %}

{% block extra_js %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // =========================================================
        // DOM Element Caching
        // =========================================================
        const dom = {
            selectedProfileIdInput: document.getElementById('selected_profile_id'),
            selectedMotorcycleIdInput: document.getElementById('selected_motorcycle_id'),
            profileSearchInput: document.getElementById('profileSearch'),
            profileSearchResults: document.getElementById('profileSearchResults'),
            selectedProfileDisplay: document.getElementById('selectedProfileDisplay'),
            motorcycleSection: document.getElementById('motorcycleSection'),
            motorcycleDropdown: document.getElementById('motorcycleDropdown'),
            selectedMotorcycleDisplay: document.getElementById('selectedMotorcycleDisplay'),
            bookingDetailsSection: document.getElementById('bookingDetailsSection'),
        };

        // =========================================================
        // AJAX URLs
        // =========================================================
        const ajaxUrls = {
            searchCustomer: "{{ ajax_search_customer_url }}",
            getCustomerDetails: "{{ admin_api_get_customer_details }}",
            getCustomerMotorcycles: "{{ ajax_get_customer_motorcycles_url }}",
            getMotorcycleDetails: "{{ ajax_get_motorcycle_details_url }}",
            serviceDateAvailability: "{{ ajax_service_date_availability_url }}",
            dropoffTimeAvailability: "{{ ajax_dropoff_time_availability_url }}",
        };

        // =========================================================
        // UI Update Functions
        // =========================================================
        function updateProfileDisplay(profileData) {
            if (profileData) {
                dom.selectedProfileDisplay.innerHTML = `
                    <strong>Selected Profile:</strong> <span>${profileData.name}</span> (<span>${profileData.email}</span>)<br>
                    <span>${profileData.phone_number}</span>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-3 mt-2" id="clearProfileSelection">Clear Selection</button>
                `;
                dom.selectedProfileDisplay.classList.remove('d-none');
                document.getElementById('clearProfileSelection').addEventListener('click', clearProfileSelection);
            } else {
                dom.selectedProfileDisplay.classList.add('d-none');
                dom.selectedProfileDisplay.innerHTML = '';
            }
        }

        function updateMotorcycleDisplay(motorcycleData) {
             if (motorcycleData) {
                dom.selectedMotorcycleDisplay.innerHTML = `
                    <strong>Selected Motorcycle:</strong> <span>${motorcycleData.brand} ${motorcycleData.model}</span> (<span>${motorcycleData.rego}</span>)<br>
                    <button type="button" class="btn btn-sm btn-outline-danger ms-3 mt-2" id="clearMotorcycleSelection">Clear Selection</button>
                `;
                dom.selectedMotorcycleDisplay.classList.remove('d-none');
                document.getElementById('clearMotorcycleSelection').addEventListener('click', clearMotorcycleSelection);
            } else {
                dom.selectedMotorcycleDisplay.classList.add('d-none');
                dom.selectedMotorcycleDisplay.innerHTML = '';
            }
        }
        
        function updateMotorcycleDropdown(motorcycles) {
            dom.motorcycleDropdown.innerHTML = '<option value="">-- Select an existing motorcycle --</option>';
            if (motorcycles && motorcycles.length > 0) {
                motorcycles.forEach(mc => {
                    const option = new Option(`${mc.brand} ${mc.model} (${mc.rego})`, mc.id);
                    dom.motorcycleDropdown.add(option);
                });
                dom.motorcycleDropdown.disabled = false;
            } else {
                dom.motorcycleDropdown.innerHTML += '<option value="" disabled>No motorcycles found for this customer.</option>';
                dom.motorcycleDropdown.disabled = true;
            }
        }
        
        function toggleSections() {
            const profileSelected = !!dom.selectedProfileIdInput.value;
            const motorcycleSelected = !!dom.selectedMotorcycleIdInput.value;

            dom.motorcycleSection.classList.toggle('d-none', !profileSelected);
            dom.bookingDetailsSection.classList.toggle('d-none', !motorcycleSelected);
        }

        // =========================================================
        // Event Handlers & Core Logic
        // =========================================================
        function clearProfileSelection() {
            dom.selectedProfileIdInput.value = '';
            dom.profileSearchInput.value = '';
            dom.profileSearchResults.innerHTML = '';
            updateProfileDisplay(null);
            clearMotorcycleSelection(); // Clearing profile also clears motorcycle
        }

        function clearMotorcycleSelection() {
            dom.selectedMotorcycleIdInput.value = '';
            dom.motorcycleDropdown.value = '';
            updateMotorcycleDisplay(null);
            if (dom.selectedProfileIdInput.value) { // only if a profile is still selected
                loadCustomerMotorcycles(dom.selectedProfileIdInput.value);
            } else {
                updateMotorcycleDropdown([]);
                dom.motorcycleDropdown.disabled = true;
            }
            toggleSections();
        }
        
        let searchTimeout;
        dom.profileSearchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            dom.profileSearchResults.innerHTML = '';

            if (query.length < 2) return;

            searchTimeout = setTimeout(() => {
                fetch(`${ajaxUrls.searchCustomer}?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const ul = document.createElement('ul');
                        if (data.profiles && data.profiles.length > 0) {
                            data.profiles.forEach(profile => {
                                const li = document.createElement('li');
                                li.textContent = `${profile.name} (${profile.email || profile.phone_number})`;
                                li.dataset.profileId = profile.id;
                                li.addEventListener('click', () => selectProfile(profile.id));
                                ul.appendChild(li);
                            });
                        } else {
                            ul.innerHTML = '<li>No profiles found.</li>';
                        }
                        dom.profileSearchResults.innerHTML = ''; // Clear previous results
                        dom.profileSearchResults.appendChild(ul);
                    })
                    .catch(error => console.error('Error searching profiles:', error));
            }, 300);
        });

        function selectProfile(profileId) {
            dom.selectedProfileIdInput.value = profileId;
            dom.profileSearchResults.innerHTML = '';
            
            fetch(ajaxUrls.getCustomerDetails.replace('0/', `${profileId}/`))
                .then(response => response.json())
                .then(data => {
                    updateProfileDisplay(data.profile_details);
                    dom.profileSearchInput.value = data.profile_details.name;
                })
                .catch(error => console.error('Error fetching profile details:', error));

            loadCustomerMotorcycles(profileId);
            toggleSections();
        }

        function loadCustomerMotorcycles(profileId) {
            fetch(ajaxUrls.getCustomerMotorcycles.replace('0/', `${profileId}/`))
                .then(response => response.json())
                .then(data => {
                    updateMotorcycleDropdown(data.motorcycles);
                    // If a motorcycle was already selected, try to re-select it
                    if (dom.selectedMotorcycleIdInput.value) {
                       dom.motorcycleDropdown.value = dom.selectedMotorcycleIdInput.value;
                    }
                })
                .catch(error => console.error('Error loading motorcycles:', error));
        }

        dom.motorcycleDropdown.addEventListener('change', function() {
            const motorcycleId = this.value;
            if (motorcycleId) {
                selectMotorcycle(motorcycleId);
            } else {
                clearMotorcycleSelection();
            }
        });

        function selectMotorcycle(motorcycleId) {
            dom.selectedMotorcycleIdInput.value = motorcycleId;
            fetch(ajaxUrls.getMotorcycleDetails.replace('0/', `${motorcycleId}/`))
                .then(response => response.json())
                .then(data => {
                    updateMotorcycleDisplay(data.motorcycle_details);
                })
                .catch(error => console.error('Error fetching motorcycle details:', error));
            toggleSections();
        }
        
        // =========================================================
        // Flatpickr Initialization
        // =========================================================
        function initFlatpickr() {
            fetch(ajaxUrls.serviceDateAvailability)
                .then(response => response.json())
                .then(data => {
                    const commonOptions = { dateFormat: "Y-m-d", minDate: "today", disable: data.disabled_dates };
                    
                    flatpickr(".flatpickr-admin-date-input", commonOptions);

                    flatpickr(".flatpickr-admin-time-input", {
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: "H:i",
                        time_24hr: true,
                    });
                })
                .catch(error => console.error('Error fetching date availability:', error));
        }
        
        // =========================================================
        // Initial Page Load
        // =========================================================
        function initializeForm() {
            const initialProfileId = dom.selectedProfileIdInput.value;
            const initialMotorcycleId = dom.selectedMotorcycleIdInput.value;

            if (initialProfileId) {
                selectProfile(initialProfileId);
                if (initialMotorcycleId) {
                    selectMotorcycle(initialMotorcycleId);
                }
            }
            toggleSections();
            initFlatpickr();
        }

        initializeForm();
    });
    </script>
{% endblock %}
