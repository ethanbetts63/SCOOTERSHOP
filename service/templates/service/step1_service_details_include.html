{# service/templates/service/step1_service_details_include.html #}
{% load static %}

<div class="container book-service-container">
    <div class="card has-bg-effect service-booking-card">
        <div class="card-body">
            <h2 class="section-title booking-title">Book Your Service</h2>

            <form method="post" action="{% url 'service:service_book_step1' %}" class="booking-form-container service-booking-form">
                {% csrf_token %}

                <div class="date-time-rows-group">
                    <div class="form-field service-type-field">
                        <label for="id_service_type">Service Type</label>
                        {{ form.service_type }} {# This will render the ModelChoiceField for ServiceType #}
                    </div>

                    <div class="date-time-row">
                        <div class="form-field">
                            <label for="id_dropoff_date">Drop-off Date</label>
                            <input type="text" id="id_dropoff_date" name="dropoff_date"
                                   class="form-control"
                                   placeholder="Select drop-off date"
                                   data-min-date-flatpickr="{{ min_service_date_flatpickr|default:'' }}">
                        </div>
                        <div class="form-field">
                            <label for="id_dropoff_time">Drop-off Time</label>
                             <select id="id_dropoff_time" name="dropoff_time"
                                     class="form-control">
                                 <option value="">Select drop-off time</option>
                             </select>
                        </div>
                    </div>

                    <div class="search-button-column">
                        <button type="submit" class="btn-primary book-now-btn">
                            Search
                        </button>
                    </div>
                </div>

                {# Hidden fields for GET parameters to persist filters/sorting #}
                {% if request.GET %}
                    {% for key, value in request.GET.items %}
                        {% if key not in 'dropoff_date,dropoff_time,service_type' %} {# Adjusted for service booking fields #}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </form>
        </div>
    </div>
</div>

{# Flatpickr CSS and JS are now self-contained within this include #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const dropOffTimeSelect = document.getElementById('id_dropoff_time');
        const dropOffDatePickerInput = document.getElementById('id_dropoff_date');
        
        // Retrieve min date from data attribute (set by Django context)
        const minDateFlatpickr = dropOffDatePickerInput.getAttribute('data-min-date-flatpickr');

        // Retrieve blocked dates JSON from Django context, ensure it's safe to parse
        const blockedDatesRaw = "{{ blocked_service_dates_json|escapejs }}";
        let blockedDates = [];
        try {
            blockedDates = JSON.parse(blockedDatesRaw || '[]');
        } catch (e) {
            console.error("Error parsing blocked dates JSON:", e);
        }

        const dropOffDatePicker = flatpickr("#id_dropoff_date", {
            dateFormat: "Y-m-d",
            minDate: minDateFlatpickr, // Use min date from context
            altInput: true,
            altFormat: "F j, Y",
            disable: blockedDates, // Directly use the parsed blockedDates
            onChange: function(selectedDates, dateStr, instance) {
                if (selectedDates.length > 0) {
                    // When a date is selected, fetch available times for that date
                    fetchAvailableTimes(dateStr);
                } else {
                    // If date is cleared (e.g., by user clearing the field), clear time options
                    clearTimeOptions("Select drop-off time"); // Reset to default text
                }
            }
        });

        /**
         * Clears all options from the drop-off time select dropdown,
         * and adds a default option with custom text.
         * @param {string} defaultText - The text to display for the default option.
         */
        function clearTimeOptions(defaultText = "Select drop-off time") {
            // Remove all existing options
            while (dropOffTimeSelect.options.length > 0) {
                dropOffTimeSelect.remove(0);
            }
            // Add the default option with customizable text
            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.text = defaultText;
            dropOffTimeSelect.appendChild(defaultOption);
            dropOffTimeSelect.value = ""; // Reset the select to its default (empty) value
        }

        /**
         * Fetches available time slots for a given date via AJAX and populates the dropdown.
         * @param {string} date - The selected date in "YYYY-MM-DD" format.
         */
        async function fetchAvailableTimes(date) {
            clearTimeOptions("Loading times..."); // Set initial text to "Loading times..."
            dropOffTimeSelect.disabled = true; // Disable during fetch

            try {
                // Construct the URL for the AJAX endpoint
                const url = `{% url 'service:get_available_times_for_date' %}?date=${date}`;
                const response = await fetch(url);
                const data = await response.json();

                // Always clear and reset to "Select drop-off time" after fetch completes
                // This ensures "Loading times..." is replaced.
                clearTimeOptions("Select drop-off time"); 

                if (response.ok) {
                    if (data.available_times && data.available_times.length > 0) {
                        // Add fetched times
                        data.available_times.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time.value; // e.g., "09:00"
                            option.text = time.text;   // e.g., "09:00"
                            dropOffTimeSelect.appendChild(option);
                        });
                    } else {
                        // If no times are available, update the default option text
                        dropOffTimeSelect.options[0].text = "No times available";
                    }
                } else {
                    // Handle server-side errors
                    dropOffTimeSelect.options[0].text = data.error || "Error loading times"; // Display error from backend
                    console.error("Error fetching available times:", data.error);
                }
            } catch (error) {
                // Handle network errors or other unexpected issues
                console.error('Network error fetching available times:', error);
                dropOffTimeSelect.options[0].text = "Error loading times"; // Set error message
            } finally {
                // Always re-enable the select dropdown after the fetch operation
                dropOffTimeSelect.disabled = false;

                // Attempt to re-select the initial drop-off time if it was pre-filled
                // from the Django context (temp_service_booking) and is now available.
                const initialDropOffTime = "{{ temp_service_booking.dropoff_time|time:'H:i'|default:'' }}";
                if (initialDropOffTime && [...dropOffTimeSelect.options].some(opt => opt.value === initialDropOffTime)) {
                    dropOffTimeSelect.value = initialDropOffTime;
                }
            }
        }

        // --- Initial Load Logic ---
        // Populate form fields from Django context if available (from TempServiceBooking)
        const initialDropOffDate = "{{ temp_service_booking.dropoff_date|date:'Y-m-d'|default:'' }}";
        const initialServiceType = "{{ temp_service_booking.service_type.pk|default:'' }}";

        // If an initial drop-off date is provided from the backend (e.g., returning to this step),
        // set the date in Flatpickr and then fetch the available times for that date.
        if (initialDropOffDate) {
            dropOffDatePicker.setDate(initialDropOffDate);
            fetchAvailableTimes(initialDropOffDate); 
        } else {
            // If no initial date, ensure the time dropdown is set to "Select drop-off time"
            clearTimeOptions("Select drop-off time");
        }

        // Pre-select the service type if an initial value is provided
        const serviceTypeSelect = document.getElementById('id_service_type');
        if (initialServiceType && serviceTypeSelect) {
            if ([...serviceTypeSelect.options].some(opt => opt.value === initialServiceType)) {
                serviceTypeSelect.value = initialServiceType;
            }
        }
    });
</script>
