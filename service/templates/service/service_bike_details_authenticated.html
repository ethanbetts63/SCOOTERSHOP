{# templates/service_booking/service_bike_details_authenticated.html #}
{% extends 'core/layout.html' %}
{% block title %}Book Service - Step 2{% endblock %}
{% block content %}
<div class="container mt-4">
    <h2>Book Service - Step {{ step }} of {{ total_steps }}</h2>
    <hr>

    {% if messages %}
    <div class="alert alert-info">
        <ul class="messages mb-0">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# Removed the general 'Your Motorcycle Details' h3 heading #}

    {# Selection container - for choosing existing motorcycles or initiating add new #}
    <div id="selection-container" {% if display_motorcycle_details %}style="display: none;"{% endif %}>
        <div class="card mb-4">
            <div class="card-body">
                <h4 class="card-title">Select or Add Your Motorcycle</h4>
                <p class="card-text">
                    {% if has_existing_bikes %}
                        Select one of your motorcycles from the list below or add a new one.
                    {% else %}
                        Please add your motorcycle details below.
                    {% endif %}
                </p>

                {% if has_existing_bikes %}
                    {# Form for selecting an existing bike #}
                    <form method="post" id="existing-bike-form" class="mb-3">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="select_existing">
                        {{ existing_bike_form.as_p }}
                        <div class="d-flex justify-content-start align-items-center gap-3">
                            <button type="submit" class="btn btn-primary" id="continue-selected-button">Continue with Selected Motorcycle</button>
                            <button type="button" id="add-new-button" class="btn btn-secondary">Add New Motorcycle</button>
                        </div>
                    </form>
                {% else %}
                    {# If no existing bikes, show the Add New button directly #}
                     <div class="d-flex justify-content-start align-items-center gap-3">
                         <button type="button" id="add-new-button" class="btn btn-primary">Add Your First Motorcycle</button>
                     </div>
                {% endif %}
            </div>
        </div>
    </div>

    {# Details container - for adding new or editing existing motorcycles #}
    <div id="motorcycle-details-container" {% if not display_motorcycle_details %}style="display: none;"{% endif %}>
        <form method="post" id="motorcycle-form">
            {% csrf_token %}
            {# The action input will be set by JavaScript based on user interaction or initial state #}
            <input type="hidden" name="action" value="{% if editing_motorcycle %}edit_existing{% else %}add_new{% endif %}">

            {# Only include motorcycle_id when editing #}
            {# Pass the ID if we are editing a specific instance #}
            {% if editing_motorcycle and editing_motorcycle.pk %}
                <input type="hidden" name="motorcycle_id" value="{{ editing_motorcycle.pk }}">
            {% endif %}

            <div class="mb-3">
                {# Combined Heading/Description based on mode #}
                {# Removed the separate h4 and p tags and combined their logic here #}
                <h4 id="motorcycle-details-heading-paragraph">
                    {% if editing_motorcycle %}
                        Please confirm the details for your selected motorcycle: {{ editing_motorcycle }}
                    {% else %}
                         New Motorcycle Details: Please provide the details of your motorcycle.
                    {% endif %}
                </h4>
            </div>

            {# The form fields #}
            {{ motorcycle_form.as_p }}

            <div class="d-flex justify-content-between mt-4">
                {% if has_existing_bikes %}
                <button type="button" id="back-to-selection" class="btn btn-primary">Back to Selection</button>
                {% endif %}

                {# Button text changes based on mode #}
                <button type="submit" class="btn btn-primary">
                    {% if editing_motorcycle %}
                        Save & Continue
                    {% else %}
                        Add Motorcycle & Continue
                    {% endif %}
                </button>
            </div>
        </form>
    </div>

</div>

{# Include the improved JavaScript - separate to improve maintainability #}
<script src="{% static 'js/service_bike_details_authenticated.js' %}"></script>
{% endblock %}