{% extends "dashboard/admin_layout.html" %}
{% load static %}

{% block admin_main_content %}

<link rel="stylesheet" href="{% static 'css/service_booking_styles.css' %}">

{# Include FullCalendar's core CSS #}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

<h2>Service Bookings Calendar</h2>

<div class="card shadow mb-4">
    <div class="card-header">
        <div class="button-group-spaced mb-4">
            <a href="" class="btn-primary">
                Create booking 
            </a>
            {# Link to search bookings - updated URL #}
            <a href="" class="btn-primary">
                 Search bookings
            </a>
        </div>
    </div>
    <div class="card-body">
        <div id='fullcalendar'>
            {# FullCalendar will build the calendar inside this div #}
        </div>

        {# Color Key for Statuses (temporarily placed here, will be moved by JS) #}
        <div class="color-key" id="status-color-key" style="display: none;">
            <div class="color-key-item">
                <span class="color-box status-confirmed"></span> Confirmed
            </div>
            <div class="color-key-item">
                <span class="color-box status-pending"></span> Pending
            </div>
            <div class="color-key-item">
                <span class="color-box status-completed"></span> Completed
            </div>
            <div class="color-key-item">
                <span class="color-box status-blocked"></span> Blocked
            </div>
        </div>

    </div> {# End of card-body #}
</div> {# End of card #}

{# Include FullCalendar's core JavaScript file #}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

{# Include the interaction plugin if you plan to use features like clicking dates/events #}
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('fullcalendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },

            // Fetch events from the Django backend JSON feed - UPDATED URL
            events: '{% url "service:get_service_bookings_json" %}',

            eventContent: function(arg) {
                if (arg.event.extendedProps.is_blocked) {
                    let blockedDescription = arg.event.extendedProps.description || '';

                    let html = `
                        <div class="blocked-title">Blocked</div>
                        <div class="blocked-description">${blockedDescription}</div>
                    `;

                    let eventEl = document.createElement('div');
                    eventEl.classList.add('calendar-tile-base');
                    eventEl.classList.add('fc-event-main-custom');
                    eventEl.classList.add('status-blocked');
                    if (arg.event.extendedProps.description) {
                         eventEl.setAttribute('title', arg.event.title);
                     }
                    // Crucial: Set innerHTML for blocked events
                    eventEl.innerHTML = html;
                    return { domNodes: [eventEl] };

                } else {
                    let customerName = arg.event.extendedProps.customer_name || 'N/A';
                    // Changed 'vehicle_make' to 'vehicle_brand'
                    let vehicleBrand = arg.event.extendedProps.vehicle_brand || ''; 
                    let vehicleModel = arg.event.extendedProps.vehicle_model || '';
                    let serviceType = arg.event.extendedProps.service_type || 'Service';
                    let status = arg.event.extendedProps.status || 'pending';

                    let vehicleString = '';
                    if (vehicleBrand || vehicleModel) {
                        vehicleString = `${vehicleBrand} ${vehicleModel}`.trim();
                    }

                    if (customerName.length > 15) {
                        customerName = customerName.substring(0, 15) + '...';
                    }

                    let html = `
                        <div class="booking-title">${customerName}</div>
                        <div class="booking-details">${serviceType}</div>
                    `;
                    if (vehicleString) {
                         html += `<div class="booking-details">${vehicleString}</div>`;
                    }

                    let eventEl = document.createElement('div');
                    eventEl.classList.add('calendar-tile-base');
                    eventEl.classList.add('fc-event-main-custom');
                    eventEl.classList.add(`status-${status}`);
                    // Crucial: Set innerHTML for regular booking events
                    eventEl.innerHTML = html; 
                    return { domNodes: [eventEl] };
                }
            },

            eventClick: function(info) {
                console.log('Event clicked:', info.event.title);
                console.log('Event ID:', info.event.id);
                console.log('Event URL:', info.event.url);
                console.log('Event Extended Props:', info.event.extendedProps);

                 if (info.event.extendedProps.is_blocked) {
                     info.jsEvent.preventDefault();
                     return;
                 }

                if (info.event.url) {
                    window.location.href = info.event.url;
                }
            },
        });

        calendar.render();

        var colorKeyElement = document.getElementById('status-color-key');
        var headerRightChunk = calendarEl.querySelector('.fc-toolbar-chunk:last-child');

        if (colorKeyElement && headerRightChunk) {
            headerRightChunk.appendChild(colorKeyElement);
            colorKeyElement.style.display = 'flex';
        }
    });

</script>

{% endblock %}
