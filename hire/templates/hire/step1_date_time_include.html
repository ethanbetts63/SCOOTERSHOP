{# hire/templates/hire/step1_date_time_include.html #}
{% load static %}

<div class="container book-service-container">
    <div class="card has-bg-effect service-booking-card">
        <div class="card-body">
            <h2 class="section-title booking-title">Find Your Hire Motorcycle</h2>

            {# CHANGE: method="post" and action points to the new Step 1 view URL #}
            <form method="post" action="{% url 'hire:step1_select_datetime' %}" class="booking-form-container hire-booking-form">
                {% csrf_token %}

                <div class="date-time-rows-group">
                    <div class="date-time-row">
                        <div class="form-field">
                            <label for="id_pick_up_date">Pick Up Date</label>
                            {# Use Django form field naming convention id_fieldname #}
                            <input type="text" id="id_pick_up_date" name="pick_up_date"
                                   class="form-control"
                                   placeholder="Select pick up date">
                        </div>
                        <div class="form-field">
                            <label for="id_pick_up_time">Pick Up Time</label>
                             {# Replace input with select for pick up time #}
                             {# Use Django form field naming convention id_fieldname #}
                             <select id="id_pick_up_time" name="pick_up_time"
                                     class="form-control"
                                     data-start-time="{{ hire_settings.pick_up_start_time|time:'H:i' }}"
                                     data-end-time="{{ hire_settings.pick_up_end_time|time:'H:i' }}">
                                 <option value="">Select pick up time</option>
                                 {# Time options will be populated by JavaScript #}
                             </select>
                        </div>
                    </div>

                    <div class="date-time-row">
                        <div class="form-field">
                            <label for="id_return_date">Return Date</label>
                            {# Use Django form field naming convention id_fieldname #}
                             <input type="text" id="id_return_date" name="return_date"
                                    class="form-control"
                                   placeholder="Select return date">
                        </div>
                         <div class="form-field">
                            <label for="id_return_time">Return Time</label>
                             {# Replace input with select for return time #}
                             {# Use Django form field naming convention id_fieldname #}
                             <select id="id_return_time" name="return_time"
                                     class="form-control"
                                     {# Use data attributes to store time range from settings #}
                                     {# Assuming 'hire_settings' object is available in the template context #}
                                     data-start-time="{{ hire_settings.return_off_start_time|time:'H:i' }}"
                                     data-end-time="{{ hire_settings.return_end_time|time:'H:i' }}">
                                 <option value="">Select return time</option>
                                 {# Time options will be populated by JavaScript #}
                             </select>
                        </div>
                    </div>

                    <div class="search-button-column">
                        {# The button triggers the form POST #}
                        <button type="submit" class="btn-primary book-now-btn">
                            Search
                        </button>
                    </div>
                </div>


                <div class="license-checkbox-container">
                    {# Use Django form field naming convention id_fieldname #}
                    <input type="checkbox" id="id_has_motorcycle_license" name="has_motorcycle_license" value="true">
                    <label class="checkbox-label" for="id_has_motorcycle_license" title="Under australian law you are able to ride up to a 50cc without a motorcycle license provided you have a car license.">I have a motorcycle license</label>
                </div>

                {# Add hidden fields to hold original GET parameters if you want to persist search filters after date selection #}
                {# This might be useful if the include form lives on the bike list page #}
                {% if request.GET %}
                    {% for key, value in request.GET.items %}
                        {# Exclude date/time/license fields, as they are handled by the form #}
                        {% if key not in 'pick_up_date,pick_up_time,return_date,return_time,has_motorcycle_license' %}
                            <input type="hidden" name="{{ key }}" value="{{ value }}">
                        {% endif %}
                    {% endfor %}
                {% endif %}


            </form>
        </div>
    </div>
</div>

{# Keep Flatpickr CSS for date fields #}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">

{# Keep Flatpickr JS for date fields #}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log("--- step1_date_time_include.html script START ---");

        // Initialize Flatpickr for date fields
        const pickUpDatePicker = flatpickr("#id_pick_up_date", {
            dateFormat: "Y-m-d",
            minDate: "today",
            altInput: true,
            altFormat: "F j, Y",
            onChange: function(selectedDates, dateStr, instance) {
                console.log("Pick Up Date changed to:", dateStr);
                handleDateAndTimeUpdates();
            }
        });

        const returnDatePicker = flatpickr("#id_return_date", {
            dateFormat: "Y-m-d",
            minDate: "today",
            altInput: true,
            altFormat: "F j, Y",
            onChange: function(selectedDates, dateStr, instance) {
                console.log("Return Date changed to:", dateStr);
                handleDateAndTimeUpdates();
            }
        });

        const pickUpTimeSelect = document.getElementById('id_pick_up_time');
        const returnTimeSelect = document.getElementById('id_return_time');

        const pickUpStartTimeAttr = pickUpTimeSelect ? pickUpTimeSelect.getAttribute('data-start-time') : null;
        const pickUpEndTimeAttr = pickUpTimeSelect ? pickUpTimeSelect.getAttribute('data-end-time') : null;
        const returnStartTimeAttr = returnTimeSelect ? returnTimeSelect.getAttribute('data-start-time') : null;
        const returnEndTimeAttr = returnTimeSelect ? returnTimeSelect.getAttribute('data-end-time') : null;

        console.log("Data attributes for time ranges:");
        console.log("Pick Up Start:", pickUpStartTimeAttr, "End:", pickUpEndTimeAttr);
        console.log("Return Start:", returnStartTimeAttr, "End:", returnEndTimeAttr);


        function populateTimeDropdown(selectElement, startTimeStr, endTimeStr, intervalMinutes) {
            if (!selectElement || !startTimeStr || !endTimeStr) {
                console.log("populateTimeDropdown: Missing required info, exiting.");
                return;
            }
            console.log(`Populating time dropdown for ${selectElement.id} from ${startTimeStr} to ${endTimeStr} with interval ${intervalMinutes} mins.`);

            const currentValue = selectElement.value; // Store current value before clearing
            console.log(`Stored current value for ${selectElement.id}: ${currentValue}`);

            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            const [startHour, startMinute] = startTimeStr.split(':').map(Number);
            const [endHour, endMinute] = endTimeStr.split(':').map(Number);

            let currentTime = new Date();
            currentTime.setHours(startHour, startMinute, 0, 0);

            const endTime = new Date();
            endTime.setHours(endHour, endMinute, 0, 0);

            if (endTime < currentTime) {
                endTime.setDate(endTime.getDate() + 1);
            }

            while (currentTime <= endTime) {
                const option = document.createElement('option');
                const hours = currentTime.getHours().toString().padStart(2, '0');
                const minutes = currentTime.getMinutes().toString().padStart(2, '0');
                const timeValue = `${hours}:${minutes}`;
                option.value = timeValue;
                option.text = timeValue;
                selectElement.appendChild(option);
                currentTime.setMinutes(currentTime.getMinutes() + intervalMinutes);
            }
            console.log(`Finished populating time dropdown for ${selectElement.id}. Options count: ${selectElement.options.length}`);

            // Attempt to restore the value after repopulation
            if ([...selectElement.options].some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
                console.log(`Restored value for ${selectElement.id} to: ${selectElement.value}`);
            } else {
                console.log(`Could not restore value ${currentValue} for ${selectElement.id}, it's not a valid option anymore.`);
            }
        }

        function handleDateAndTimeUpdates() {
            console.log("handleDateAndTimeUpdates called.");
            const pickUpDate = pickUpDatePicker.selectedDates[0];
            const returnDate = returnDatePicker.selectedDates[0];
            const pickUpTime = pickUpTimeSelect ? pickUpTimeSelect.value : null;

            console.log("Current selected dates:", "Pick Up:", pickUpDate, "Return:", returnDate);
            console.log("Current selected pick up time:", pickUpTime);

            if (pickUpDate) {
                console.log("Setting return date minDate to:", pickUpDate);
                returnDatePicker.set('minDate', pickUpDate);
                if (returnDate && returnDate < pickUpDate) {
                    console.log("Return date is before new minDate, clearing return date.");
                    returnDatePicker.clear();
                }
            } else {
                console.log("Pick up date is not selected, setting return date minDate to 'today'.");
                returnDatePicker.set('minDate', 'today');
            }

            let actualReturnStartTime = returnStartTimeAttr;
            console.log("Initial actualReturnStartTime:", actualReturnStartTime);

            if (pickUpDate && returnDate && pickUpDate.toDateString() === returnDate.toDateString()) {
                console.log("Pick up and Return dates are the same day.");
                if (pickUpTime) {
                    console.log("Pick up time is selected:", pickUpTime);
                    const [puHour, puMinute] = pickUpTime.split(':').map(Number);
                    const pickUpTimeDate = new Date();
                    pickUpTimeDate.setHours(puHour, puMinute, 0, 0);

                    const [retStartHour, retStartMinute] = returnStartTimeAttr.split(':').map(Number);
                    const defaultReturnStartDate = new Date();
                    defaultReturnStartDate.setHours(retStartHour, retStartMinute, 0, 0);

                    const [retEndHour, retEndMinute] = returnEndTimeAttr.split(':').map(Number);
                    const defaultReturnEndDate = new Date();
                    defaultReturnEndDate.setHours(retEndHour, retEndMinute, 0, 0);

                    console.log("Comparison times:", "Pick Up Time Date:", pickUpTimeDate, "Default Return Start Date:", defaultReturnStartDate, "Default Return End Date:", defaultReturnEndDate);

                    if (pickUpTimeDate >= defaultReturnStartDate) {
                        console.log("Selected pickup time is >= default return start time. Using selected pickup time as actualReturnStartTime.");
                        actualReturnStartTime = pickUpTime;
                        if (pickUpTimeDate > defaultReturnEndDate && defaultReturnEndDate >= defaultReturnStartDate) {
                            console.log("Selected pickup time is > default return end time (end is after start). Capping actualReturnStartTime at returnEndTimeAttr.");
                            actualReturnStartTime = returnEndTimeAttr;
                        } else if (pickUpTimeDate > defaultReturnEndDate && defaultReturnEndDate < defaultReturnStartDate) {
                            console.log("Selected pickup time is > default return end time (end is next day). Keeping selected pickup time as actualReturnStartTime.");
                            actualReturnStartTime = pickUpTime;
                        }
                    } else {
                        console.log("Selected pickup time is < default return start time. Using default return start time as actualReturnStartTime.");
                        actualReturnStartTime = returnStartTimeAttr;
                    }
                } else {
                    console.log("No pickup time selected yet, but dates are same day. Using default return start time as actualReturnStartTime.");
                    actualReturnStartTime = returnStartTimeAttr;
                }
            } else {
                console.log("Return date is after pick up date. Using default return start time as actualReturnStartTime.");
                actualReturnStartTime = returnStartTimeAttr;
            }

            console.log("Final actualReturnStartTime determined:", actualReturnStartTime);

            // Re-populate the return time dropdown with the determined start time and the original end time
            // The populateTimeDropdown function now handles saving and restoring the value internally.
            populateTimeDropdown(returnTimeSelect, actualReturnStartTime, returnEndTimeAttr, 15);
        }

        // Populate the pick-up time dropdown initially
        if (pickUpTimeSelect && pickUpStartTimeAttr && pickUpEndTimeAttr) {
            console.log("Populating initial pick-up time dropdown.");
            populateTimeDropdown(pickUpTimeSelect, pickUpStartTimeAttr, pickUpEndTimeAttr, 15);
        }

        // Add event listener to the pick up time select to update return time options
        if (pickUpTimeSelect) {
            console.log("Adding change listener to pick-up time select.");
            pickUpTimeSelect.addEventListener('change', handleDateAndTimeUpdates);
        }

        // Initial call to update return time options based on default selected dates and times
        console.log("Performing initial handleDateAndTimeUpdates call.");
        handleDateAndTimeUpdates();


        // --- Pre-fill form from session data on page load ---
        const sessionPickUpDate = "{{ original_inputs.pick_up_date|default:'' }}";
        const sessionPickUpTime = "{{ original_inputs.pick_up_time|default:'' }}";
        const sessionReturnDate = "{{ original_inputs.return_date|default:'' }}";
        const sessionReturnTime = "{{ original_inputs.return_time|default:'' }}";
        const sessionHasLicense = "{{ original_inputs.has_motorcycle_license|default:'false' }}";

        console.log("Session data read from template context:");
        console.log("sessionPickUpDate:", sessionPickUpDate);
        console.log("sessionPickUpTime:", sessionPickUpTime);
        console.log("sessionReturnDate:", sessionReturnDate);
        console.log("sessionReturnTime:", sessionReturnTime);
        console.log("sessionHasLicense:", sessionHasLicense);


        if (sessionPickUpDate) {
            console.log("Attempting to set pick-up date with:", sessionPickUpDate);
            pickUpDatePicker.setDate(sessionPickUpDate);
            console.log("Pick-up date set result:", pickUpDatePicker.selectedDates[0]);
        } else {
            console.log("No sessionPickUpDate found to pre-fill.");
        }

        if (sessionReturnDate) {
            console.log("Attempting to set return date with:", sessionReturnDate);
            returnDatePicker.setDate(sessionReturnDate);
            console.log("Return date set result:", returnDatePicker.selectedDates[0]);
        } else {
            console.log("No sessionReturnDate found to pre-fill.");
        }

        // Order is important here:
        // 1. Populate pick-up time dropdown (done before handleDateAndTimeUpdates)
        // 2. Set pick-up time from session
        // 3. Populate return time dropdown (this happens inside handleDateAndTimeUpdates, which is called twice)
        // 4. Set return time from session

        // Set pick-up time. The `populateTimeDropdown` for pick-up time has already run initially.
        if (sessionPickUpTime && pickUpTimeSelect) {
            console.log("Attempting to set pick-up time with:", sessionPickUpTime);
            if ([...pickUpTimeSelect.options].some(opt => opt.value === sessionPickUpTime)) {
                pickUpTimeSelect.value = sessionPickUpTime;
                console.log("Pick-up time set to:", pickUpTimeSelect.value);
            } else {
                console.log(`Option with value ${sessionPickUpTime} not found in pick-up time select.`);
            }
        } else {
            console.log("No sessionPickUpTime or pickUpTimeSelect not found to pre-fill.");
        }

        // Set return time. The populateTimeDropdown for return time will run again
        // due to the second handleDateAndTimeUpdates call below.
        // It's best to set the value after that.
        // So, this initial setting for returnTimeSelect might be immediately overwritten.
        // The fix is now inside populateTimeDropdown itself.
        if (sessionReturnTime && returnTimeSelect) {
            console.log("Attempting to set return time with:", sessionReturnTime);
            if ([...returnTimeSelect.options].some(opt => opt.value === sessionReturnTime)) {
                returnTimeSelect.value = sessionReturnTime;
                console.log("Return time set to (pre-second handle):", returnTimeSelect.value);
            } else {
                console.log(`Option with value ${sessionReturnTime} not found in return time select (pre-second handle).`);
            }
        } else {
            console.log("No sessionReturnTime or returnTimeSelect not found to pre-fill.");
        }


        const hasLicenseCheckbox = document.getElementById('id_has_motorcycle_license');
        if (hasLicenseCheckbox) {
            console.log("Attempting to set license checkbox with:", sessionHasLicense);
            if (sessionHasLicense === 'true') {
                hasLicenseCheckbox.checked = true;
                console.log("License checkbox checked.");
            } else {
                hasLicenseCheckbox.checked = false;
                console.log("License checkbox unchecked.");
            }
        } else {
            console.log("License checkbox element not found.");
        }


        // IMPORTANT: Perform the second handleDateAndTimeUpdates call *after* pre-filling dates
        // This ensures return time options are re-calculated correctly based on the selected pickup date.
        // The populateTimeDropdown now handles preserving the selected value.
        console.log("Performing second handleDateAndTimeUpdates call after pre-filling dates/times.");
        handleDateAndTimeUpdates();

        console.log("--- step1_date_time_include.html script END ---");

    });
</script>
