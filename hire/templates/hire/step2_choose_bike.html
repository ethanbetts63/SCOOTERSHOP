{% extends "core/layout.html" %}
{% load static %}
{% load mathfilters %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/motorcycle_list_styles.css' %}">
<link rel="stylesheet" href="{% static 'core/css/book_include_styles.css' %}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
{% endblock %}

{% block content %}

{# Include the Step 1 Date/Time form here #}
{# Pass original_inputs from the view's context for pre-filling #}
{# Pass hire_settings for time ranges #}
{% include "hire/includes/step1_date_time_include.html" with original_inputs=original_inputs hire_settings=hire_settings %}


    <div class="hire-section">
        <div class="hire-tiles-container">

            {% if hire_start_date and hire_end_date %}
            <div class="card card-border card-hover-effect availability-info">
                <div class="card-body">
                    <h3>Available Motorcycles</h3>
                    {# Display dates and duration from session data passed via context #}
                    <p>Showing motorcycles available for hire from <strong>{{ hire_start_date|date:"D, d M Y" }}</strong> to <strong>{{ hire_end_date|date:"D, d M Y" }}</strong> ({{ hire_days }} day{% if hire_days > 1 %}s{% endif %}).</p>

                    <div class="alert alert-info">
                        {# Keep the note about availability subject to confirmation #}
                        <p>Please note that motorcycle availability is subject to confirmation.</p>
                         {# You can add a note about license here if has_motorcycle_license is false #}
                        {% if hire_settings and hire_settings.requires_license_above_50cc and not has_motorcycle_license %}
                             <p>Based on your selection, only motorcycles 50cc or below are shown as you indicated you do not have a motorcycle license (Australian Law).</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% elif original_inputs %}
                {# Optional: Show a message if the user arrived with selected dates but no bikes found #}
                 <div class="card card-border card-hover-effect availability-info">
                     <div class="card-body">
                          <div class="alert alert-warning">
                               <h3>No Motorcycles Found for Selected Dates</h3>
                               <p>We couldn't find any motorcycles available for hire from <strong>{{ original_inputs.pick_up_date|date:"D, d M Y" }}</strong> to <strong>{{ original_inputs.return_date|date:"D, d M Y" }}</strong>. Please adjust your dates or try again later.</p>
                          </div>
                     </div>
                 </div>
            {% else %}
                 {# Message handled by view if no session data exists #}
            {% endif %}
        </div>
    </div>

    {% with current_url_name='hire:step2_choose_bike' page_title='Motorcycles Available for Hire' %} {# Use the correct URL name #}

        <div class="container-fluid mt-4">
            {% if page_title %}
                <h1 class="mb-4">{{ page_title }}</h1>
            {% else %}
                <h1 class="mb-4">Motorcycles</h1>
            {% endif %}

            <div class="results-header mb-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="results-count">
                        {% with total_count=paginator.count %} {# Use paginator from context #}
                            {% if motorcycles %}
                                {% if is_paginated %}
                                    <span class="fw-bold">{{ page_obj.start_index|default:"1" }}</span> to
                                    <span class="fw-bold">{{ page_obj.end_index|default:total_count }}</span> of {# Corrected typo here #}
                                {% endif %}
                                <span class="fw-bold">{{ total_count }}</span> products for hire
                            {% else %}
                                <span class="fw-bold">0</span> products for hire
                            {% endif %}
                        {% endwith %}
                    </div>
                    <div class="sort-options">
                        <form method="get" action="" class="d-flex align-items-center">
                            <label for="order" class="form-label me-2 mb-0">Sort by:</label>
                            <select class="form-select form-select-sm" id="order" name="order" onchange="this.form.submit()">

                                <option value="price_low_to_high" {% if current_order == 'price_low_to_high' or not current_order %}selected{% endif %}>Hire Rate: Low to High</option>
                                <option value="price_high_to_low" {% if current_order == 'price_high_to_low' %}selected{% endif %}>Hire Rate: High to Low</option>

                                <option value="age_new_to_old" {% if current_order == 'age_new_to_old' %}selected{% endif %}>Year: Newest First</option>
                                <option value="age_old_to_new" {% if current_order == 'age_old_to_new' %}selected{% endif %}>Year: Oldest First</option>

                            </select>

                            {# Keep only the 'order' parameter in the hidden fields for sorting form #}
                            {% for key, value in request.GET.items %}
                                {% if key == 'order' %}
                                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                                {% endif %}
                            {% endfor %}

                        </form>
                    </div>
                </div>
            </div>

            <div class="motorcycle-grid">
                {# REMOVED: The entire search-options card was here #}

                {% for motorcycle in motorcycles %}
                <div class="motorcycle-item">

                    <div class="card h-100 card-hover-effect">
                        {% if motorcycle.image %}
                            <img src="{{ motorcycle.image.url }}" class="card-img-top img-cover" alt="{{ motorcycle.title }}">
                        {% else %}
                            <img src="{% static 'images/no_image.jpg' %}" class="card-img-top img-cover" alt="No Image Available">
                        {% endif %}
                        <div class="card-body text-center">
                            <h5 class="card-title">{{ motorcycle.year }} {{ motorcycle.brand }} {{ motorcycle.model }}</h5>

                            <div class="motorcycle-details">

                                <div class="detail-item">
                                    <span class="svg-icon svg-icon-md icon-seat"></span>
                                    <span class="detail-label">Seats</span>
                                    <span class="detail-value">
                                        {% if motorcycle.seats %}
                                            {{ motorcycle.seats }}
                                        {% else %}
                                            1
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="detail-item">
                                    <span class="svg-icon svg-icon-md icon-transmission"></span>
                                    <span class="detail-label">Transmission</span>
                                    <span class="detail-value">
                                        {% if motorcycle.transmission %}
                                            {{ motorcycle.get_transmission_display }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </span>
                                </div>

                                <div class="detail-item">
                                    <span class="svg-icon svg-icon-md icon-capacity"></span>
                                    <span class="detail-label">Engine</span>
                                    <span class="detail-value">{{ motorcycle.engine_size }}cc</span>
                                </div>

                            </div>

                            <ul class="list-unstyled features-list">
                                <li>Unlimited mileage</li>
                                <li>Fuel efficient</li>
                            </ul>

                            <p class="card-text fw-bold">
                                {# Display the calculated daily rate if available #}
                                {% if motorcycle.display_daily_rate is not None %}
                                    from ${{ motorcycle.display_daily_rate|floatformat:2 }} per day
                                {% else %}
                                    Contact for price
                                {% endif %}
                            </p>

                             {# Display the total price for the period if dates are selected #}
                            {% if motorcycle.total_hire_price is not None %}
                                 <p class="card-text total-price">Total for period: ${{ motorcycle.total_hire_price|floatformat:2 }}</p>
                            {% endif %}


                            <p class="card-text location"><small class="text-muted">{{ motorcycle.location }}</small></p>
                        </div>
                         <div class="card-footer text-center button-container">
                             {# View Details Button #}
                             <a href="{% url 'inventory:motorcycle-detail' motorcycle.pk %}" class="btn-secondary">View Details</a>

                             {# Select Button - Needs JS to submit a form or redirect to Step 3 with bike ID #}
                             {# For now, keep the button structure #}
                             {# The next step will involve adding functionality to this button #}
                             <button type="button" class="select-motorcycle-btn" data-motorcycle-id="{{ motorcycle.pk }}">Select</button>
                         </div>
                    </div>
                </div>
                {% empty %}
                {# This message will show if the queryset is empty (e.g., no session data, or no bikes match) #}
                <div class="col-12 text-center py-5">
                    <h3>No motorcycles found matching your criteria.</h3>
                    <p>Try adjusting your hire dates above or check back later.</p> {# Direct user to the date selector #}
                </div>
                {% endfor %}
            </div>

            {% if is_paginated %}
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center reset-list">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        {# Ensure other GET parameters (like 'order') are carried in pagination links #}
                        <a class="page-link" href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; First</a>
                    </li>
                    <li class="page-item">
                        {# Ensure other GET parameters (like 'order') are carried in pagination links #}
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
                    </li>
                    {% endif %}

                    {% for num in paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active">
                        <span class="page-link">{{ num }}</span>
                    </li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item">
                        {# Ensure other GET parameters (like 'order') are carried in pagination links #}
                        <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                    </li>
                    {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                    <li class="page-item">
                        {# Ensure other GET parameters (like 'order') are carried in pagination links #}
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a> {# Corrected closing tag #}
                    </li>
                    <li class="page-item">
                         {# Ensure other GET parameters (like 'order') are carried in pagination links #}
                        <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Last &raquo;</a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>

    {% endwith %}
{% endblock %}

{% block extra_js %}
{# Include the JS from the date/time include directly here, or ensure it's loaded. #}
{# Since we are including the HTML file, the script tags within it should execute. #}
{# If they don't, you might need to move the JS content here or ensure proper loading. #}
{# Based on your previous include, the JS is inside the include, which is typical. #}

<script>
document.addEventListener('DOMContentLoaded', function() {

    // The Flatpickr initialization and populateTimeDropdown logic
    // should already be present and working from the included
    // step1_date_time_include.html file.

    // We only need JS here for the "Select" buttons on each motorcycle.
    // This will handle redirecting to the next step (Add-ons/Packages).
    const selectButtons = document.querySelectorAll('.select-motorcycle-btn');

    selectButtons.forEach(button => {
        button.addEventListener('click', function() {
            const motorcycleId = this.dataset.motorcycleId;
            // Redirect to Step 3 URL, passing the motorcycle ID
            // You'll need to define the URL name for Step 3 in your urls.py
            window.location.href = `/hire/booking/addons/${motorcycleId}/`; // Example URL pattern
            // Or use Django's URL reversing if you can pass the URL name dynamically
            // e.g., window.location.href = "{% url 'hire:step3_addons' 0 %}".replace('0', motorcycleId);
            // This requires the URL tag to be rendered in the template.
        });
    });

    // Keep the JS for the sorting form if you still want sort options
    // The sorting form is still in the HTML, so its JS is likely handled by the browser submit

    // If you had any JS specifically for the removed search options card, remove it here.

});
</script>
{% endblock %}