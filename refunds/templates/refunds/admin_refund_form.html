{% extends "dashboard/admin_layout.html" %}

{% block extra_css %}
{{ block.super }}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* General Form Styling */
    .form-group input,
    .form-group select,
    .form-group textarea {
        border: 1px solid #ced4da;
        color: #495057;
        width: 100%;
        padding: 0.5rem 0.75rem;
        border-radius: 0.25rem;
        font-size: 1rem;
        line-height: 1.5;
        background-color: #fff;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    .form-group .errorlist {
        list-style-type: none;
        padding: 0;
        margin-top: 0.5rem;
        color: #ef4444; /* red-500 */
        font-size: 0.875rem;
    }
    .form-group .helptext {
        font-size: 0.875rem;
        color: #6b7280; /* gray-500 */
        margin-top: 0.5rem;
    }
    .required-indicator {
        color: red;
        margin-left: 5px;
    }
    .hidden, [hidden] {
        display: none !important;
    }

    /* Loader and Error Styling */
    .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    .error-message {
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        padding: 10px 15px;
        border-radius: 5px;
        margin-top: 15px;
    }

    /* Dynamic Search Results Styling (from sales booking page) */
    .search-results-container {
        position: relative;
    }
    .search-results {
        list-style-type: none;
        padding: 0;
        margin: 0;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        max-height: 250px;
        overflow-y: auto;
        position: absolute;
        background-color: white;
        z-index: 1000;
        width: 100%;
        color: #333;
    }
    .search-results li {
        padding: 12px;
        cursor: pointer;
        color: #333;
        border-bottom: 1px solid #eee;
    }
    .search-results li:last-child {
        border-bottom: none;
    }
    .search-results li:hover {
        background-color: #f0f0f0;
    }
    .search-results li strong {
        font-weight: 600;
        color: #000;
    }
    .search-results li small {
        font-size: 0.85rem;
        color: #555;
    }

    /* Selected Item Display Styling */
    .selected-item-display {
        padding: 1rem;
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        margin-top: 1rem;
        color: #333;
    }
    .selected-item-display small,
    .selected-item-display span.text-muted {
        color: #555 !important;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block admin_main_content %}
<div class="container mx-auto px-4 py-8 font-inter">
    <div class="bg-white shadow-lg rounded-lg p-6 md:p-8 max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold text-gray-800">{{ title }}</h1>
        </div>

        <form method="post" class="space-y-6" novalidate>
            {% csrf_token %}

            {% if form.non_field_errors %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong>Form Errors:</strong>
                    <ul class="list-disc pl-5 mt-2">
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <fieldset class="space-y-4">
                <legend class="text-lg font-medium text-gray-900">Refund Request Details</legend>

                <div class="form-group">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Select Booking Type<span class="required-indicator">*</span></label>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <input class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" type="radio" name="booking_type_selector" id="serviceBookingRadio" value="service" {% if not form.instance.pk or form.instance.service_booking %}checked{% endif %}>
                            <label for="serviceBookingRadio" class="ml-2 block text-sm text-gray-900">Service Booking</label>
                        </div>
                        <div class="flex items-center">
                            <input class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" type="radio" name="booking_type_selector" id="salesBookingRadio" value="sales" {% if form.instance.sales_booking %}checked{% endif %}>
                            <label for="salesBookingRadio" class="ml-2 block text-sm text-gray-900">Sales Booking</label>
                        </div>
                    </div>
                </div>

                <div id="serviceBookingSection" class="form-group">
                    <label for="serviceBookingSearchInput" class="block text-sm font-medium text-gray-700 mb-1">
                        Search Service Booking (Reference, Customer, Motorcycle)
                        {% if form.service_booking.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    <div class="search-results-container">
                        <input type="text" id="serviceBookingSearchInput" class="form-control" placeholder="Start typing to search service bookings...">
                        <ul id="serviceBookingSearchResults" class="search-results" hidden></ul>
                    </div>
                    <div id="selectedServiceBookingDisplay" class="selected-item-display" hidden></div>
                    {{ form.service_booking.as_hidden }}
                    {% if form.service_booking.errors %}<div class="text-red-500 text-xs mt-1">{% for error in form.service_booking.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.service_booking.help_text }}</p>
                </div>
                
                <div id="salesBookingSection" class="form-group">
                    <label for="salesBookingSearchInput" class="block text-sm font-medium text-gray-700 mb-1">
                        Search Sales Booking (Reference, Customer, Motorcycle)
                        {% if form.sales_booking.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    <div class="search-results-container">
                        <input type="text" id="salesBookingSearchInput" class="form-control" placeholder="Start typing to search sales bookings...">
                        <ul id="salesBookingSearchResults" class="search-results" hidden></ul>
                    </div>
                    <div id="selectedSalesBookingDisplay" class="selected-item-display" hidden></div>
                    {{ form.sales_booking.as_hidden }}
                    {% if form.sales_booking.errors %}<div class="text-red-500 text-xs mt-1">{% for error in form.sales_booking.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.sales_booking.help_text }}</p>
                </div>
                
                <div id="loader" class="loader hidden"></div>
                <div id="ajaxError" class="error-message hidden"></div>
                <div id="bookingDetailsContainer" class="booking-details-box hidden p-4 bg-gray-50 rounded-md mt-4"></div>

                <div class="form-group">
                    <label for="{{ form.reason.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.reason.label }}
                        {% if form.reason.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.reason }}
                    {% if form.reason.errors %}<div class="text-red-500 text-xs mt-1">{% for error in form.reason.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.reason.help_text }}</p>
                </div>

                <div class="form-group">
                    <label for="{{ form.staff_notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.staff_notes.label }}
                        {% if form.staff_notes.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.staff_notes }}
                    {% if form.staff_notes.errors %}<div class="text-red-500 text-xs mt-1">{% for error in form.staff_notes.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.staff_notes.help_text }}</p>
                </div>

                <div class="form-group">
                    <label for="{{ form.amount_to_refund.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                        {{ form.amount_to_refund.label }}
                        {% if form.amount_to_refund.field.required %}<span class="required-indicator">*</span>{% endif %}
                    </label>
                    {{ form.amount_to_refund }}
                    {% if form.amount_to_refund.errors %}<div class="text-red-500 text-xs mt-1">{% for error in form.amount_to_refund.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    <p class="text-xs text-gray-500 mt-1">{{ form.amount_to_refund.help_text }}</p>
                </div>
            </fieldset>

            <div class="flex items-center justify-start space-x-4 mt-6 border-t pt-6">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Save Refund Request</button>
                <a href="{% url 'refunds:admin_refund_management' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DOM Elements ---
    const dom = {
        serviceBookingRadio: document.getElementById('serviceBookingRadio'),
        salesBookingRadio: document.getElementById('salesBookingRadio'),
        serviceBookingSection: document.getElementById('serviceBookingSection'),
        salesBookingSection: document.getElementById('salesBookingSection'),
        serviceBookingHiddenInput: document.getElementById('id_service_booking'),
        serviceBookingSearchInput: document.getElementById('serviceBookingSearchInput'),
        serviceBookingSearchResults: document.getElementById('serviceBookingSearchResults'),
        selectedServiceBookingDisplay: document.getElementById('selectedServiceBookingDisplay'),
        salesBookingHiddenInput: document.getElementById('id_sales_booking'),
        salesBookingSearchInput: document.getElementById('salesBookingSearchInput'),
        salesBookingSearchResults: document.getElementById('salesBookingSearchResults'),
        selectedSalesBookingDisplay: document.getElementById('selectedSalesBookingDisplay'),
        amountToRefundInput: document.getElementById('id_amount_to_refund'),
        bookingDetailsContainer: document.getElementById('bookingDetailsContainer'),
        loader: document.getElementById('loader'),
        ajaxErrorContainer: document.getElementById('ajaxError'),
    };

    // --- State ---
    let searchTimeout = null;

    // --- URLs (from Django context) ---
    const urls = {
        serviceDetails: '{{ service_booking_details_url|escapejs }}',
        salesDetails: '{{ sales_booking_details_url|escapejs }}',
        searchSales: '{{ search_sales_bookings_url|escapejs }}',
        searchService: '{{ search_service_bookings_url|escapejs }}',
    };

    // --- Functions ---
    function hideAllDetails() {
        dom.bookingDetailsContainer.hidden = true;
        dom.ajaxErrorContainer.hidden = true;
    }

    function handleBookingTypeChange() {
        hideAllDetails();
        dom.amountToRefundInput.value = '0.00';
        clearServiceBookingSelection(); // Always clear service selection when type changes
        clearSalesBookingSelection(); // Always clear sales selection when type changes

        const isService = dom.serviceBookingRadio.checked;
        dom.serviceBookingSection.hidden = !isService;
        dom.salesBookingSection.hidden = isService;

        // Enable/disable inputs based on selected type
        dom.serviceBookingHiddenInput.disabled = !isService;
        dom.serviceBookingSearchInput.disabled = !isService;
        dom.salesBookingHiddenInput.disabled = isService;
        dom.salesBookingSearchInput.disabled = isService;

        // If service is selected, ensure search input is enabled
        if (isService) {
            dom.serviceBookingSearchInput.removeAttribute('disabled');
        } else { // If sales is selected, ensure sales search input is enabled
            dom.salesBookingSearchInput.removeAttribute('disabled');
        }
    }

    function displayBookingDetails(data, bookingType) {
        let detailsHtml = '';
        const bookingRef = bookingType === 'service' ? data.service_booking_reference : data.sales_booking_reference;

        detailsHtml = `
            <h5 class="font-bold text-lg mb-2 text-gray-900">${bookingType.charAt(0).toUpperCase() + bookingType.slice(1)} Booking Refund Details</h5>
            <p class="text-gray-800"><strong>Customer:</strong> ${data.customer_name}</p>
            <p class="text-gray-800"><strong>Booking Ref:</strong> ${bookingRef}</p>
            <p class="text-gray-800"><strong>Payment Amount:</strong> ${data.payment_amount}</p>
            <p class="text-gray-800"><strong>Booking Status:</strong> ${data.booking_status}</p>
            <p class="text-gray-800"><strong>Payment Status:</strong> ${data.payment_status}</p>
            <p class="text-gray-800"><strong>Entitled Refund:</strong> ${data.entitled_refund_amount}</p>
            <p class="text-gray-800"><strong>Calculation Details:</strong> ${data.refund_calculation_details}</p>
        `;
        dom.bookingDetailsContainer.innerHTML = detailsHtml;
        dom.bookingDetailsContainer.hidden = false;
        dom.amountToRefundInput.value = parseFloat(data.entitled_refund_amount).toFixed(2);
    }

    function fetchBookingDetails(bookingType, bookingId) {
        hideAllDetails();
        if (!bookingId) return;

        const url = (bookingType === 'service' ? urls.serviceDetails : urls.salesDetails).replace('/0/', `/${bookingId}/`);
        dom.loader.classList.remove('hidden');

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                displayBookingDetails(data, bookingType);
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                dom.ajaxErrorContainer.textContent = `Failed to fetch details: ${error.message}`;
                dom.ajaxErrorContainer.hidden = false;
            })
            .finally(() => {
                dom.loader.classList.add('hidden');
            });
    }

    // --- Service Booking Search Functions ---
    function performServiceBookingSearch(query) {
        dom.loader.classList.remove('hidden');
        dom.serviceBookingSearchResults.innerHTML = '';
        dom.serviceBookingSearchResults.hidden = true;
        dom.ajaxErrorContainer.hidden = true;

        fetch(`${urls.searchService}?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                dom.serviceBookingSearchResults.innerHTML = '';
                if (data.bookings && data.bookings.length > 0) {
                    data.bookings.forEach(booking => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>${booking.reference}</strong> - ${booking.customer_name}<br>
                            <small>${booking.motorcycle_info} | ${booking.dropoff_date} ${booking.dropoff_time}</small>
                        `;
                        li.dataset.bookingId = booking.id;
                        li.dataset.displayText = `${booking.reference} - ${booking.customer_name} - ${booking.motorcycle_info}`;
                        li.addEventListener('click', () => selectServiceBooking(booking.id, booking.reference, booking.customer_name, booking.motorcycle_info, booking.dropoff_date, booking.dropoff_time));
                        dom.serviceBookingSearchResults.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No results found.';
                    dom.serviceBookingSearchResults.appendChild(li);
                }
                dom.serviceBookingSearchResults.hidden = false;
            })
            .catch(error => {
                console.error('Service Search Error:', error);
                dom.ajaxErrorContainer.textContent = `Failed to search service bookings: ${error.message}`;
                dom.ajaxErrorContainer.hidden = false;
            })
            .finally(() => {
                dom.loader.classList.add('hidden');
            });
    }

    function selectServiceBooking(bookingId, reference, customerName, motorcycleInfo, dropoffDate, dropoffTime) {
        dom.serviceBookingHiddenInput.value = bookingId;
        dom.serviceBookingSearchInput.value = `${reference} - ${customerName} - ${motorcycleInfo} (${dropoffDate} ${dropoffTime})`;
        dom.serviceBookingSearchInput.setAttribute('disabled', 'disabled');
        dom.serviceBookingSearchResults.hidden = true;

        updateServiceBookingDisplay({ reference, customer_name: customerName, motorcycle_info: motorcycleInfo, dropoff_date: dropoffDate, dropoff_time: dropoffTime });
        fetchBookingDetails('service', bookingId);
    }

    function updateServiceBookingDisplay(bookingData) {
        if (bookingData) {
            dom.selectedServiceBookingDisplay.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <strong>Selected Booking:</strong> ${bookingData.reference} - ${bookingData.customer_name}<br>
                        <small class="text-muted">${bookingData.motorcycle_info} (${bookingData.dropoff_date} ${bookingData.dropoff_time})</small>
                    </div>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-2 rounded-md text-sm" id="clearServiceBookingSelection">Clear</button>
                </div>
            `;
            dom.selectedServiceBookingDisplay.hidden = false;
            document.getElementById('clearServiceBookingSelection').addEventListener('click', clearServiceBookingSelection);
        } else {
            dom.selectedServiceBookingDisplay.hidden = true;
            dom.selectedServiceBookingDisplay.innerHTML = '';
        }
    }

    function clearServiceBookingSelection() {
        dom.serviceBookingHiddenInput.value = '';
        dom.serviceBookingSearchInput.value = '';
        dom.serviceBookingSearchInput.removeAttribute('disabled');
        dom.serviceBookingSearchInput.focus();
        dom.selectedServiceBookingDisplay.hidden = true;
        dom.selectedServiceBookingDisplay.innerHTML = '';
        hideAllDetails();
    }

    // --- Sales Booking Search Functions ---
    function performSalesBookingSearch(query) {
        dom.loader.classList.remove('hidden');
        dom.salesBookingSearchResults.innerHTML = '';
        dom.salesBookingSearchResults.hidden = true;
        dom.ajaxErrorContainer.hidden = true;

        fetch(`${urls.searchSales}?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.error) throw new Error(data.error);
                
                dom.salesBookingSearchResults.innerHTML = '';
                if (data.bookings && data.bookings.length > 0) {
                    data.bookings.forEach(booking => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>${booking.reference}</strong> - ${booking.customer_name}<br>
                            <small>${booking.motorcycle_info}</small>
                        `;
                        li.dataset.bookingId = booking.id;
                        li.dataset.displayText = `${booking.reference} - ${booking.customer_name} - ${booking.motorcycle_info}`;
                        li.addEventListener('click', () => selectSalesBooking(booking.id, booking.reference, booking.customer_name, booking.motorcycle_info));
                        dom.salesBookingSearchResults.appendChild(li);
                    });
                } else {
                    const li = document.createElement('li');
                    li.textContent = 'No results found.';
                    dom.salesBookingSearchResults.appendChild(li);
                }
                dom.salesBookingSearchResults.hidden = false;
            })
            .catch(error => {
                console.error('Search Error:', error);
                dom.ajaxErrorContainer.textContent = `Failed to search: ${error.message}`;
                dom.ajaxErrorContainer.hidden = false;
            })
            .finally(() => {
                dom.loader.classList.add('hidden');
            });
    }

    function selectSalesBooking(bookingId, reference, customerName, motorcycleInfo) {
        dom.salesBookingHiddenInput.value = bookingId;
        dom.salesBookingSearchInput.value = `${reference} - ${customerName} - ${motorcycleInfo}`;
        dom.salesBookingSearchInput.setAttribute('disabled', 'disabled');
        dom.salesBookingSearchResults.hidden = true;

        updateSalesBookingDisplay({ reference, customer_name: customerName, motorcycle_info: motorcycleInfo });
        fetchBookingDetails('sales', bookingId);
    }
    
    function updateSalesBookingDisplay(bookingData) {
        if (bookingData) {
            dom.selectedSalesBookingDisplay.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <strong>Selected Booking:</strong> ${bookingData.reference} - ${bookingData.customer_name}<br>
                        <small class="text-muted">${bookingData.motorcycle_info}</small>
                    </div>
                    <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-medium py-1 px-2 rounded-md text-sm" id="clearSalesBookingSelection">Clear</button>
                </div>
            `;
            dom.selectedSalesBookingDisplay.hidden = false;
            document.getElementById('clearSalesBookingSelection').addEventListener('click', clearSalesBookingSelection);
        } else {
            dom.selectedSalesBookingDisplay.hidden = true;
            dom.selectedSalesBookingDisplay.innerHTML = '';
        }
    }

    function clearSalesBookingSelection() {
        dom.salesBookingHiddenInput.value = '';
        dom.salesBookingSearchInput.value = '';
        dom.salesBookingSearchInput.removeAttribute('disabled');
        dom.salesBookingSearchInput.focus();
        dom.selectedSalesBookingDisplay.hidden = true;
        dom.selectedSalesBookingDisplay.innerHTML = '';
        hideAllDetails();
    }

    // --- Event Listeners ---
    dom.serviceBookingRadio.addEventListener('change', handleBookingTypeChange);
    dom.salesBookingRadio.addEventListener('change', handleBookingTypeChange);

    dom.serviceBookingSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        if (query.length < 2) {
            dom.serviceBookingSearchResults.hidden = true;
            return;
        }
        searchTimeout = setTimeout(() => performServiceBookingSearch(query), 300);
    });

    dom.serviceBookingSearchResults.addEventListener('click', function(event) {
        const selectedBookingId = event.target.dataset.bookingId;
        if (selectedBookingId) {
            const reference = event.target.querySelector('strong').textContent.split(' -')[0];
            const customerName = event.target.querySelector('strong').textContent.split(' -')[1].trim();
            const smallElements = event.target.querySelectorAll('small');
            const motorcycleInfo = smallElements[0] ? smallElements[0].textContent : '';
            const dropoffDetails = smallElements[1] ? smallElements[1].textContent.split(' | ') : [];
            const dropoffDate = dropoffDetails[0] ? dropoffDetails[0].trim() : '';
            const dropoffTime = dropoffDetails[1] ? dropoffDetails[1].trim() : '';

            selectServiceBooking(selectedBookingId, reference, customerName, motorcycleInfo, dropoffDate, dropoffTime);
        }
    });

    dom.salesBookingSearchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value.trim();
        if (query.length < 2) {
            dom.salesBookingSearchResults.hidden = true;
            return;
        }
        searchTimeout = setTimeout(() => performSalesBookingSearch(query), 300);
    });

    dom.salesBookingSearchResults.addEventListener('click', function(event) {
        const selectedBookingId = event.target.dataset.bookingId;
        if (selectedBookingId) {
            const reference = event.target.querySelector('strong').textContent.split(' -')[0];
            const customerName = event.target.querySelector('strong').textContent.split(' -')[1].trim();
            const motorcycleInfo = event.target.querySelector('small') ? event.target.querySelector('small').textContent : '';
            selectSalesBooking(selectedBookingId, reference, customerName, motorcycleInfo);
        }
    });

    // Hide search results when clicking outside
    document.addEventListener('click', function(event) {
        const isClickInsideServiceSearch = dom.serviceBookingSearchInput.contains(event.target) || dom.serviceBookingSearchResults.contains(event.target);
        const isClickInsideSalesSearch = dom.salesBookingSearchInput.contains(event.target) || dom.salesBookingSearchResults.contains(event.target);
        
        if (!isClickInsideServiceSearch) {
            dom.serviceBookingSearchResults.hidden = true;
        }
        if (!isClickInsideSalesSearch) {
            dom.salesBookingSearchResults.hidden = true;
        }
    });

    // --- Initial Load Logic ---
    function initializeForm() {
        const initialServiceBookingId = dom.serviceBookingHiddenInput.value;
        const initialSalesBookingId = dom.salesBookingHiddenInput.value;
        
        // Set initial state based on radio buttons
        handleBookingTypeChange(); 

        if (dom.serviceBookingRadio.checked && initialServiceBookingId) {
            const url = urls.serviceDetails.replace('/0/', `/${initialServiceBookingId}/`);
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data && !data.error) {
                        selectServiceBooking(
                            initialServiceBookingId,
                            data.service_booking_reference,
                            data.customer_name,
                            data.motorcycle_info,
                            data.dropoff_date,
                            data.dropoff_time
                        );
                    } else {
                        console.error("Error fetching initial service booking details:", data.error);
                    }
                })
                .catch(err => console.error("Fetch error for initial service booking details:", err));
        } else if (dom.salesBookingRadio.checked && initialSalesBookingId) {
            const url = urls.salesDetails.replace('/0/', `/${initialSalesBookingId}/`);
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if (data && !data.error) {
                        selectSalesBooking(
                            initialSalesBookingId,
                            data.sales_booking_reference,
                            data.customer_name,
                            data.motorcycle_info
                        );
                    } else {
                        console.error("Error fetching initial sales booking details:", data.error);
                    }
                })
                .catch(err => console.error("Fetch error for initial sales booking details:", err));
        }
    }

    initializeForm();
});
</script>
{% endblock %}
