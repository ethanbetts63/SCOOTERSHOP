{% extends "dashboard/admin_layout.html" %}
{% load static %}

{% block admin_main_content %}
<link rel="stylesheet" href="{% static 'css/service_booking_styles.css' %}">
{# Link for calendar-specific styles #}
<link rel="stylesheet" href="{% static 'css/calendar_styles.css' %}">

<h2>Service Bookings Calendar</h2>

{# Container for the search and filtering section (existing or planned) #}
<div class="card shadow mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">Search & Filters</h6>
    </div>
    <div class="card-body">
        {# Search form and filter options will go here #}
        <p>Search and filter options coming soon...</p>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">Booking Calendar</h6>
    </div>
    <div class="card-body">
        {# Main container for the calendar #}
        <div id="booking-calendar">
            {# Calendar header: Month and Year, Navigation #}
            <div class="calendar-header">
                <button id="prev-month">Previous</button>
                <h3 id="current-month-year">{{ current_month|date:"F Y" }}</h3>
                <button id="next-month">Next</button>
            </div>

            {# Day names row #}
            <div class="calendar-weekdays">
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
                <div>Sun</div>
            </div>

            {# Calendar days grid #}
            <div class="calendar-days">
                {% for week in calendar %}
                    {% for day in week %}
                        {% comment %}
                        Check if the day is within the displayed month.
                        Using day.month and day.year directly from the date object in calendar_data.
                        {% endcomment %}
                        {% if day.is_current_month %}
                            {# Day within the current month - Make it clickable #}
                            <a href="{% url 'dashboard:service_bookings_day' year=day.day.year month=day.day.month day=day.day.day %}" class="calendar-day current-month {% if day.has_bookings %}has-bookings{% endif %}">
                                <div class="day-number">{{ day.day.day }}</div>
                                {% if day.bookings %}
                                    <div class="booking-count">{{ day.bookings|length }} booking{{ day.bookings|length|pluralize }}</div>
                                {% endif %}
                            </a>
                        {% else %}
                            {# Day outside the current month - Not clickable #}
                            <div class="calendar-day other-month">
                                <div class="day-number">{{ day.day.day }}</div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            </div>
        </div>
    </div>
</div>

{# The existing recent bookings list can remain below the calendar or be moved #}
<div class="card shadow mb-4">
    <div class="card-header d-flex flex-column align-items-center">
        <h6 class="m-0 font-weight-bold text-primary card-header-title">Recent Bookings (List View)</h6>
    </div>
    <div class="card-body">
        {% if bookings %}
            <div class="booking-list">
                {% for booking in bookings|slice:":5" %}
                    <div class="booking-tile card mb-2" data-detail-url="{% url 'dashboard:service_booking_details' pk=booking.pk %}">
                         <div class="card-body py-2 px-3">
                            <div class="booking-details">
                                <div class="booking-info-line">
                                    <span class="customer-name">{{ booking.customer_name }}</span>
                                    <span class="separator">|</span>
                                    <span class="booking-datetime"><i class="far fa-calendar-alt mr-1"></i> {{ booking.appointment_datetime|date:"Y-m-d H:i" }}</span>
                                    <span class="separator">|</span>
                                    <span class="service-type"><i class="fas fa-tools mr-1"></i> {{ booking.service_type.name }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No recent service bookings found.</p>
        {% endif %}
    </div>
    <div class="text-center mt-3">
        {# This link might change or be removed once the calendar view is primary #}
        <a href="{% url 'dashboard:service_bookings' %}" class="btn btn-primary btn-sm">
             View All Bookings <i class="fas fa-arrow-right"></i>
        </a>
    </div>
</div>


    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const bookingTiles = document.querySelectorAll('.booking-tile');
            bookingTiles.forEach(tile => {
                tile.addEventListener('click', function() {
                    const detailUrl = this.getAttribute('data-detail-url');
                    if (detailUrl) {
                        window.location.href = detailUrl;
                    }
                });
            });
             // Basic JavaScript for calendar navigation (will require server-side handling)
            const prevMonthButton = document.getElementById('prev-month');
            const nextMonthButton = document.getElementById('next-month');
            // No need to grab currentMonthYearHeader if we are just redirecting

            // Assuming the current month and year are available from the server context
            const currentYear = '{{ current_month.year|default:0 }}';
            const currentMonth = '{{ current_month.month|default:1 }}';
 
            prevMonthButton.addEventListener('click', function() {
                let newMonth = currentMonth - 1;
                let newYear = currentYear;
                if (newMonth < 1) {
                    newMonth = 12;
                    newYear--;
                }
                // Redirect to the same bookings page with previous month/year parameters
                // Ensure URL is correctly generated
                window.location.href = "{% url 'dashboard:service_bookings' %}" + `?year=${newYear}&month=${newMonth}`;
            });

            nextMonthButton.addEventListener('click', function() {
                let newMonth = currentMonth + 1;
                let newYear = currentYear;
                if (newMonth > 12) {
                    newMonth = 1;
                    newYear++;
                }
                 // Redirect to the same bookings page with next month/year parameters
                 // Ensure URL is correctly generated
                window.location.href = "{% url 'dashboard:service_bookings' %}" + `?year=${newYear}&month=${newMonth}`;
            });
        });
    </script>

{% endblock %}