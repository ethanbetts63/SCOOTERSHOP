{% extends "dashboard/admin_layout.html" %}
{% load static %}

{% block admin_main_content %}

<link rel="stylesheet" href="{% static 'css/service_booking_styles.css' %}">

{# Include FullCalendar's core CSS #}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/main.min.css' rel='stylesheet' />

<h2>Service Bookings Calendar</h2>

{# Button group for booking actions #}
<div class="button-group-spaced mb-4"> {# Using existing class for spacing, added margin-bottom #}
    {# Link to create booking for existing user #}
    <a href="{% url 'service:admin_booking_user' %}" class="btn-primary"> {# Using existing button primary style #}
        Create booking (existing user)
    </a>
    {# Link to create booking for one-off user #}
    <a href="{% url 'service:admin_booking_anon' %}" class="btn-primary"> {# Using existing button primary style #}
        Create booking (one-off user)
    </a>
    {# Link to search bookings - keeping the existing search button, just moving it #}
    <a href="{% url 'dashboard:service_booking_search' %}" class="btn-primary"> {# Using existing button primary style #}
         Search bookings
    </a>
</div>


<div class="card shadow mb-4">
    <div class="card-header">
        <h6 class="m-0 font-weight-bold text-primary">Booking Calendar</h6>
    </div>
    <div class="card-body">
        <div id='fullcalendar'>
            {# FullCalendar will build the calendar inside this div #}
        </div>
    </div>
</div>

{# Include FullCalendar's core JavaScript file #}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

{# Include the interaction plugin if you plan to use features like clicking dates/events #}
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('fullcalendar'); // Get the HTML element

        var calendar = new FullCalendar.Calendar(calendarEl, {
            // ** REQUIRED OPTIONS **
            initialView: 'dayGridMonth', // Specifies the default view (e.g., month view)

            // ** OPTIONAL CONFIGURATION **
            headerToolbar: { // Customize the buttons and title at the top
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay listWeek' // Added listWeek view
            },

            // --- Event Source ---
            // Fetch events from the Django backend JSON feed
            events: '{% url "dashboard:get_bookings_json" %}',

            // --- Event Rendering ---
            eventContent: function(arg) {
                // arg.event contains the event object from your JSON feed
                let customerName = arg.event.extendedProps.customer_name || 'N/A';
                let vehicleMake = arg.event.extendedProps.vehicle_make || '';
                let vehicleModel = arg.event.extendedProps.vehicle_model || '';
                let serviceType = arg.event.extendedProps.service_type || 'Service';
                let status = arg.event.extendedProps.status || 'pending'; // Default to pending if status is not set

                // Construct the vehicle string, only if make or model exists
                let vehicleString = '';
                if (vehicleMake || vehicleModel) {
                    vehicleString = `${vehicleMake} ${vehicleModel}`.trim();
                }

                // Use a shorter version of the customer name if it's too long for the tile
                if (customerName.length > 15) { // Adjust length as needed
                    customerName = customerName.substring(0, 15) + '...';
                }

                let html = `
                    <div class="booking-title">${customerName}</div>
                    <div class="booking-details">${serviceType}</div>
                `;
                if (vehicleString) {
                     html += `<div class="booking-details">${vehicleString}</div>`;
                }


                // The main container for the custom content
                // Add a class based on the event status for specific styling
                let eventEl = document.createElement('div');
                eventEl.classList.add('fc-event-main-custom');
                eventEl.classList.add(`status-${status}`); // e.g., status-confirmed
                eventEl.innerHTML = html;

                return { domNodes: [eventEl] };
            },


            // --- Interactivity (Using the interaction plugin) ---
            dateClick: function(info) {
                // This function is called when a date is clicked
                console.log('Date clicked:', info.dateStr);
                // Redirect to your day view
                const year = info.date.getFullYear();
                const month = info.date.getMonth() + 1; // Month is 0-indexed
                const day = info.date.getDate();
                window.location.href = `/dashboard/service-bookings/${year}/${month}/${day}/`;
            },

            eventClick: function(info) {
                // This function is called when an event (booking) is clicked
                console.log('Event clicked:', info.event.title); // Original title
                console.log('Event ID:', info.event.id);
                console.log('Event URL:', info.event.url);
                console.log('Event Extended Props:', info.event.extendedProps);


                // Redirect to the booking details page using the event's URL property
                if (info.event.url) {
                    window.location.href = info.event.url;
                }
            },

        });

        // Render the calendar on the page
        calendar.render();
    });

</script>

{% endblock %}
